
Ext.util.CSS.removeStyleSheet('bsw');
Ext.util.CSS.createStyleSheet(
  ' '
  + ' .bsw-county-item {'
  + '     padding-top: 10px;'
  + '     padding-bottom: 6px;'
  + '     border-top: 1px dashed #000;'
  + '     font-weight: bold;'
  + '     margin-top: 5px;'
  + ' }'

  + '.bsw-info {'
  + '  position: relative;'
  + '  display: inline-block;'
  + '  margin-right: 20px;'
  + '}'

  + '.bsw-info div {'
  + '  height: 12px;'
  + '  width: 12px;'
  + '  border-radius: 12px;'
  + '  border: 1px solid #3e9bbc;'
  + '  text-align: center;'
  + '  color: white;'
  + '  font-family: robotoslab;'
  + '  font-size: 10px;'
  + '  font-weight: 500;'
  + '  font-style: italic;'
  + '  background: #3e9bbc;'
  + '  display: inline-block;'
  + '  line-height: 10px;'
  + '  letter-spacing: 1.2px;'
  + '  position: absolute;'
  + '  top: -16px;'
  + '  left: 0px;'
  + '}'

  + '  .bsw-select .x-form-item-body {'
  + '      max-width: 460px;'
  + '      height: 42px;'
  + '      border-radius: 3px;'
  + '      background-color: #ffffff;'
  + '      border: solid 1px rgba(36, 93, 113, 0.5);'
  + '  }'

  + '  .bsw-select input {'
  + '      color: #245d71;'
  + '      padding: 10px 14px;'
  + '  }'

  + '  .bsw-select div {'
  + '      border-radius: 3px;'
  + '  }'

  + '  .bsw-h1 h1 {'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 30px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      color: #3e9bbc;'
  + '      text-transform: none;'
  + '  }'

  + '  .bsw-header h2 {'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 18px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      color: #245d71;'
  + '      text-transform: uppercase;'
  + '  }'

  + '  .bsw-para {'
  + '      margin-top: -27px;'
  + '  }'

  + '  .bsw-body {'
  // +'      font-family: "Open Sans";'
  + '    font-size: 14px;'
  + '    font-weight: normal;'
  + '    font-style: normal;'
  + '    font-stretch: normal;'
  + '    color: #183136;'
  + '  }'

  + '  .bsw-body label {'
  + '      font-weight: normal;'
  + '      overflow: hidden;'
  + '  }'

  + '  .bsw-goal-title, .bsw-goal-percentage {'
  + '      text-align: center;'
  + '      width: 100%;'
  + '      height: 27px;'
  + '      margin: 0;'
  + '      display: flex;  '
  + '      justify-content: center;'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 18px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      letter-spacing: -0.2px;'
  + '      color: #245d71;'
  + '  }'

  + '  .bsw-goal-percentage {'
  + '      margin: -209px 0 10px 0;'
  + '      font-size: 40px;'
  + '  }'

  + '  label.bsw-goal-percentage {'
  + '      overflow: inherit;'
  + '  }'

  + '  .bsw-chartcontainer {'
  + '      margin: 40px 0 0 0;'
  + '  }'

  + '  .bsw-chartcontainer > div {'
  + '      margin: auto;'
  + '      width: 240px !important;'
  + '  }'

  + '  .bsw-inner-text {'
  + '      display: flex;'
  + '      justify-content: center;'
  + '      margin-top: 27px;'
  + '  }'

  + '  .bsw-inner-text > div {'
  + '      width: 123px !important;'
  + '  }'

  + '  .bsw-goal-percentage-text {'
  + '      padding-top: 15px;'
  + '      font-size: 12px;'
  + '      color: #183136;'
  + '      '
  + '      text-align: center;'
  + '      font-weight: normal;'
  + '      display: flex;  '
  + '      justify-content: center;'
  + '  }'

  + '  .bsw-goal-subtitle {'
  + '      text-align: center;'
  + '      display: flex;'
  + '      justify-content: center;'
  + '      font-size: 14px;'
  + '      font-weight: normal;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      line-height: 1;'
  + '      color: #183136;'
  + '      margin: 14px 0 8px 0;'
  + '  }'

  + '  .bsw-chart-title {'
  + '      margin: 35px 0 40px 9px;'
  + '  }'

  + '  .bsw-subscript {'
  + '      color: rgb(24, 49, 54);'
  + '      margin-bottom: 40px;'
  + '  }'

  + '  .bsw-goal-marker {'
  + '      height: 240px !important;'
  + '      width: 240px;'
  + '      margin: -241px 0 0 0;'
  + '      z-index: 3;'
  + '  }'

  + '  .bsw-tabs .x-tab-bar {'
  + '      background-color: white; '
  + '  }'

  + '  .bsw-tabs .x-tab-default {'
  + '      background-color: #245d71;'
  + '  }'

  + '  .bsw-tabs .x-tab {'
  + '      border: none;'
  + '      border-radius: 4px 4px 0 0;'
  + '      margin: 8px 0 6px 11px !important;'
  // +'      top: 8px !important;'
  + '  }'

  + '  .bsw-tabs .x-tab-bar-body .x-box-inner {'
  + '      box-shadow: inset 0px -10px 9px -7px rgba(0,0,0,0.2);'
  // +'      height: 47px !important;'
  + '  }'

  + '  .bsw-tabs a:focus {'
  + '      outline: none;'
  + '  }'

  + '  .bsw-tabs .x-tab.x-tab-active.x-tab-default {'
  + '      background-color: white; '
  + '      box-shadow: 0px 0px 10px  #888888;'
  + '  }'

  + '  .bsw-tabs .x-tab-inner-default {'
  + '      font-size: 15px;'
  + '      font-weight: normal;'
  + '      padding: 11px 10px 0px 10px; '
  + '      height: 35px; '
  + '      background-color: #245d71;'
  + '      color: white; '
  + '  }'

  + '  .bsw-tabs .x-tab.x-tab-active.x-tab-default .x-tab-inner-default {'
  + '      color: #245d71; '
  + '      background-color: white;'
  + '  }'

  + '  .bsw-select label {'
  + '      white-space: nowrap;'
  + '      vertical-align: middle;'
  + '      width: 93px !important;'
  + '  }'

  + '  .bsw-body.x-container {'
  + '      margin: 0 auto 50px;'
  + '  }'

  // +'  .bsw-body div.col-md-4 {'
  // +'      border-right: 1px solid #dddddd;'
  // +'  }'

  + '  .bsw-indicator-explanation {'
  + '      height: 450px;'
  + '  }'

  + '  .bsw-body div.col-md-4:last-child {'
  + '      border-right:none;'
  + '  }'

  + '  .bsw-checkbox {'
  + '      height: 42px;'
  + '      float: left;'
  + '      min-width: 90px;'
  + '  }'

  + '  .bsw-checkbox > div {'
  + '      color: #666666;'
  + '      font: normal 14px/17px open_sans, helvetica, arial, sans-serif;'
  + '  }'

  + '  .bsw-checkbox > div > div {'
  + '      padding: 12px 0 0 0;'
  + '  }'

  + '  .bsw-checkbox-row {'
  + '      margin-left: 8px;'
  + '  }'

  + '  .bsw-checkbox input {'
  + '      background: url(https://registercentrum.blob.core.windows.net/boa/r/Utdata-checkbox-Syf_EL7wg.png); '
  + '      background-position: -8px -6px;'
  + '      height: 20px;'
  + '      width: 20px;'
  + '      margin: 0;'
  + '  }'

  + '  .bsw-checkbox span {'
  + '      background: none;'
  + '      height: 20px;'
  + '      width: 20px;'
  + '      margin: 0;'
  + '  }'

  + '  .bsw-checkbox.x-form-cb-checked input {'
  + '      background-position: -8px -38px !important;'
  + '  }'

  + '  .bsw-body .bsw-checkbox label {'
  + '      height: 20px;'
  + '      margin: 0;'
  + '      padding: 3px 3px 0 27px;'
  + '  }'

  + '  .bsw-infobar {'
  + '      margin: 30px 0 54px 0 !important;'
  + '      border-top: dashed 2px #3e9bbc;'
  + '      color: #245d71;'
  + '      padding-top: 30px;'
  + '  }'

  + '  .bsw-infobar div:nth-child(2) {'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 40px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      color: #3e9bbc;'
  + '  }'

  + '  .bsw-infobar div:nth-child(3) {'
  + '      color: #183136;'
  + '      min-height: 40px;'
  + '  }'

  + '  .bsw-tabs {'
  + '      margin-bottom: 35px;'
  + '  }'

  + '  .bsw-nav-button {'
  + '      background-color: white;'

  + '      border-radius: 30px;'
  + '      padding-top: 5px;'
  + '      box-shadow: 1px 1px 3px 0 rgba(0, 0, 0, 0.3);'
  + '      border-color: white;'
  + '      float: left;'
  + '      margin: -92px 0 0 -196px;'
  + '  }'

  + '  .bsw-body .bsw-nav-button .x-btn-inner-default-small {'
  + '      color: #245d71;'
  + '      font-family: open_sans, helvetica, arial;'
  + '      font-size: 14px;'
  + '  }'

  + '  .bsw-secondary {'
  + '      height: 50px !important;'
  + '      background: url(https://registercentrum.blob.core.windows.net/boa/r/Utdata-markers-new-SJbhLs8je.png) no-repeat !important;'
  + '      padding-left: 43px;'
  + '      cursor: pointer;'
  + '  }'

  + '  .bsw-secondary-line > div {'
  + '      width: 100% !important;'
  + '  }'

  + '  .bsw-secondary.bsw-grade-good {'
  + '      background-position: -6px 1px !important;'
  + '      color: #009666;'
  + '      display: flex;'
  + '  }'

  + '  .bsw-secondary.bsw-grade-almost {'
  + '      background-position: -6px -41px !important;'
  + '      color:  #fbb600;'
  + '      display: flex;'
  + '  }'

  + '  .bsw-secondary.bsw-grade-bad {'
  + '      background-position: -6px -83px !important;'
  + '      color: #ed4826;'
  + '      display: flex;'
  + '  }'

  + '  .bsw-secondary.bsw-grade-unknown, .bsw-secondary.bsw-grade-NA {'
  + '      background-position: -6px -128px !important;'
  + '      color: #245d71;'
  + '      display: flex;'
  + '  }'

  + '  .bsw-secondary.bsw-grade-unknown > div:first-child, .bsw-secondary.bsw-grade-NA > div:first-child {'
  + '      font-size: 16px !important;'
  + '      text-transform: uppercase;'
  + '  }'

  + '  .bsw-secondary > div {'
  + '      overflow:hidden;'
  + '      width: 110px;'
  + '  }'

  + '  .bsw-secondary > div:nth-child(1) {'
  + '      line-height: 50px;'
  + '      font-size: 30px;'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 40px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      float: left;'
  // +'      width: 14%;'
  + '      padding-right: 10px;'
  + '      text-align: right;'
  + '  }'

  + '  .bsw-secondary > div:nth-child(2) {'
  + '      display: inline-block;'
  + '      flex: 1;'
  + '  }'

  + '  .bsw-secondary::after {'
  + '      content: url("https://registercentrum.blob.core.windows.net/boa/r/Utdata-arrow-large-r1PLvs4ve.png");'
  + '      padding-top: 12px;'
  + '      padding-left: 10px;'
  + '  }'

  + '  .bsw-body .patient-rate {'
  + '    overflow: hidden;'
  + '    height: 19px;'
  + '    font-size: 14px;'
  + '    font-weight: normal;'
  + '    font-style: normal;'
  + '    font-stretch: normal;'
  + '    color: #183136;'
  + '    margin-top: 20px;'
  + '    vertical-align: top;'
  + '    margin: 7px 0 0 7px;'
  + '  }'

  + '  .bsw-body .goal-level {'
  + '    overflow: hidden;'
  + '    height: 17px;'
  + '    font-size: 12px;'
  + '    font-weight: normal;'
  + '    font-style: normal;'
  + '    font-stretch: normal;'
  + '    color: #767676;'
  + '    vertical-align: bottom;'
  + '    margin: 0 0 0 7px;'
  + '  }'

  + '  .bsw-secondary-header {'
  + '      margin-bottom: 25px;'
  + '  }'

  + '  .bsw-secondary-header .bsw-target-header {'
  + '    height: 24px;'
  + '    font-family: "Roboto Slab";'
  + '    font-size: 18px;'
  + '    font-weight: 300;'
  + '    font-style: normal;'
  + '    font-stretch: normal;'
  + '    letter-spacing: -0.2px;'
  + '    color: #245d71;'
  + '    width: 50%;'
  + '      float:left;'
  + '  }'

  + '  .bsw-secondary-line {'
  + '      margin-bottom: 26px;'
  + '  }'

  + '  .bsw-secondary-header span {'
  + '    height: 20px;'
  // +'    font-family: "Open Sans";'
  + '    font-size: 14px;'
  + '    font-weight: normal;'
  + '    font-style: normal;'
  + '    font-stretch: normal;'
  + '    color: #183136;'
  + '    display: inline-block;'
  + '    padding: 0 10px 0 26px;'
  + '    background: url(https://registercentrum.blob.core.windows.net/boa/r/Utdata-markers-small-SJpKWLQPl.png) no-repeat;'
  + '  }'

  + '  .bsw-color-legend span {'
  + '    height: 20px;'
  // +'    font-family: "Open Sans";'
  + '    font-size: 14px;'
  + '    font-weight: normal;'
  + '    font-style: normal;'
  + '    font-stretch: normal;'
  + '    color: #183136;'
  + '    display: inline-block;'
  + '    padding: 0 10px 0 26px;'
  + '    background: url(https://registercentrum.blob.core.windows.net/boa/r/Utdata-markers-small-SJpKWLQPl.png) no-repeat;'
  + '  }'

  + '  .bsw-compare .bsw-color-legend {'
  + '      margin-top: 30px;'
  + '      width: 50%;'
  + '      float: left;'
  + '  }'

  + '  .bsw-color-legend span:nth-child(1) {'
  + '      background-position: -9px -69px;'
  + '  }'

  + '  .bsw-color-legend span:nth-child(2) {'
  + '      background-position: -9px -38px;'
  + '  }'

  + '  .bsw-color-legend span:nth-child(3) {'
  + '      background-position: -9px -7px;'
  + '  }'

  + '  .bsw-trend-legend {'
  + '      margin-left: 9px;'
  + '  }'


  + '  .bsw-separator {'
  + '      border-top: dashed 2px #3e9bbc;'
  + '      color: #245d71;'
  + '      padding-top: 40px;'
  + '  }'

  + '  .bsw-button, .bsw-button:hover, .bsw-button:active, .bsw-button:focus {'
  + '      width: 200px; '
  + '      height: 40px; '
  + '      margin-left: 17px;'
  + '      border-radius: 3px; '
  + '      background-color: #ffffff; '
  + '      border: solid 1px #3e9bbc;'
  + '  }'

  + '  .bsw-button .x-btn-inner {'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 18px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      line-height: 1.67;'
  + '      color: #245d71;'

  + '  }'

  + '  .bsw-hidden {'
  + '      display: hidden'
  + '  }'

  + '  .bsw-circle {'
  + '  	border-radius: 50%;'
  + '  	width: 20px;'
  + '  	height: 20px; '
  + '      margin-right: 8px;'
  + '  }'

  + '  .bsw-details-legend {'
  + '      padding-right: 12px;'
  + '  }'

  + '  .bsw-color-seafoam {'
  + '      background-color: #7fc1d5;'
  + '  }'

  + '  .bsw-color-dark-slate {'
  + '      background-color: #245d71;'
  + '  }'

  + '  .bsw-pills a:focus {'
  + '      outline: none;'
  + '  }'

  + '  .bsw-pills .x-tab.x-tab-active.x-tab-default .x-tab-inner-default {'
  + '      border-radius: 5px;'
  + '      box-shadow: none;'
  + '      '
  + '  }'

  + '  .bsw-pills .x-box-inner {'
  + '      box-shadow: none;'
  + '  }'

  + '  .bsw-pills .x-tab-bar-body {'
  + '      border-radius: 10px;'
  + '      padding: 5px 5px;'
  + '      width:100% !important;'
  + '  }'

  + '  .bsw-body .x-panel-body-default {'
  + '      border-style: none;'
  + '  }'

  + '  .bsw-body .x-form-trigger-default, .bsw-body .x-form-trigger-default.x-form-trigger-over.x-form-trigger-focus {'
  + '      background: white url(https://registercentrum.blob.core.windows.net/boa/r/Utdata-trigger-HyzmEUmve.png) -8px 2px no-repeat;'
  + '      width: 28px;'
  + '  }'

  + '  .bsw-compare .bsw-button-group {'
  + '      margin-top: 22px;'
  + '      width: 390px;'
  + '  }'

  + '  .bsw-compare-navigation {'
  + '      margin-bottom: 20px;'
  + '  }'

  + '  .bsw-button-group {'
  + '      float: right;'
  + '      margin-right: 26px;'
  + '  }'

  + '  .bsw-button-group a {'
  + '      float: left;'
  + '      margin: 5px 0px;'
  + '      border-radius: 5px;'
  + '      border-color: white;'
  + '      box-shadow: none;'
  + '      font-size: 12px;'
  + '      font-weight: normal;'
  + '      padding: 2px 12px 0 12px ;'
  + '      height: 26px; '
  + '      background-color: white;'
  + '      color: #183136;'
  + '  }'

  + '  .bsw-button-group a:first-child {'
  + '      margin-left: 4px;'
  + '  }'

  + '  .bsw-button-group a:last-child {'
  + '      margin-right: 4px;'
  + '  }'

  + '  .bsw-body .bsw-button-group a span {'
  + '      color: #245d71;'
  + '  }'

  + '  .bsw-button-group > div {'
  + '      height: 34px;'
  + '      width: inherit !important;'
  + '  }'

  + '  .bsw-button-group > div > div {'
  + '      vertical-align: baseline;'
  + '      box-shadow: inset -1px 1px 10px -3px;'
  + '      border-radius: 5px;'
  + '      height: 34px;'
  + '  }'

  + '  .bsw-body .bsw-button-group .bsw-active-button {'
  + '      color:  white;'
  + '      background-color: #245d71;'
  + '  }'

  + '  .bsw-body .bsw-button-group .bsw-active-button span {'
  + '      color:  white;'
  + '      background-color: #245d71;'
  + '  }'

  + '  .bsw-body .x-btn-over.x-btn-default-small {'
  + '      background-color: rgba(36, 93, 113, 0.5);'
  + '      border-color: white;'
  + '  }'

  + '  .bsw-active-button {'
  + '      background-color: #245d71 !important;'
  + '      border-color: #245d71 !important;'
  + '      outline-offset: 0px;'
  + '  }'

  + '  .bsw-body .x-btn-focus.x-btn-default-small, .x-btn.x-btn-pressed.x-btn-default-small  {'
  + '      background-color: white;'
  + '      border-color: white;'
  + '      box-shadow: none !important;'
  + '  }'

  + '  .bsw-divider {'
  + '      height: 31px !important;'
  + '      float: left;'
  + '      width: 1px;'
  + '      margin: 2px 5px;'
  + '      background-color: white;'
  + '  }'

  + '  .bsw-divider.bsw-divider-show {'
  + '      background-color: lightgrey;'
  + '  }'

  + '  .bsw-box-group {'
  + '      width: 50%;'
  + '      float: left;'
  + '  }'

  + '  .bsw-box-group .bsw-checkbox {'
  + '      float: left;'
  + '  }'

  + '  .bsw-yearchart {'
  + '      margin: 0 0 17px 0;'
  + '      width: 33%;'
  + '      float: left;'
  + '      background-color: white !important;'
  + '  }'

  + '  .bsw-yearchart .x-panel-header-default {'
  + '      background-color: white;'
  + '      border: none;'
  + '  }'

  + '  .bsw-yearchart .x-panel-header-title-default {'
  + '      font-size: 12px;'
  + '      font-weight: normal;'
  + '      color: #183136;'
  + '  }'

  + '  .bsw-body .x-form-cb-label-default {'
  + '    margin-top: 4px;'
  + '    font: normal 14px helvetica,arial,sans-serif;'
  + '  }'

  + '  .bsw-body .x-btn-inner-default-small {'
  + '    font: 500 12px/15px helvetica, arial, sans-serif;'
  + '    color: white;'
  + '    padding: 0 5px;'
  + '    max-width: 100%;'
  + '  }'

  + '  .bsw-chart-no-bar {'
  + '      left: -20px;'
  + '  }'

  + '  .bsw.body .x-form-label {'
  + '      white-space: nowrap;'
  + '      overflow: hidden;'
  + '      text-overflow: ellipsis;'
  + '  }'

  + '  .bsw-table.table > thead > tr > th {'
  + '      vertical-align: middle;'
  + '  }'

  + '  .bsw-table.table > tbody > tr > td:last-child {'
  + '      border-right: none;'
  + '  }'

  + '  .bsw-table.table > thead > tr > th:last-child {'
  + '      border-right: none;'
  + '  }'

  + '  .bsw-table > tbody > tr > td {'
  + '      border: none;'
  + '  }'

  + '  .bsw-table tr:nth-child(even) {'
  + '    background-color: rgba(24, 49, 53, 0.1);'
  + '  }'

  + '  .bsw-table thead > tr:nth-child(2) {'
  + '    background-color: rgba(127, 192, 213, 0.4);'
  + '  }'

  + '  .bsw-table tbody > tr:nth-child(1), .bsw-table tr:nth-child(5), .bsw-table tr:nth-child(9), .bsw-table tr:nth-child(13)  {'
  + '    background-color: rgba(251, 182, 0, 0.1);'
  + '  }'

  + '  .bsw-table tbody > tr:nth-child(1) td, .bsw-table tr:nth-child(5) td, .bsw-table tr:nth-child(9) td, .bsw-table tr:nth-child(13) td {'
  + '    padding-left: 15px !important;'
  + '      font-weight: bold !important;'
  + '      color: #183136 !important;'
  + '  }'

  + '  .bsw-table > tbody > tr > td:nth-child(odd), .bsw-table > thead > tr > th {'
  + '      border-right: solid 1px rgba(36, 93, 113, 0.5);'
  + '      border-bottom: none;'
  + '      border-top: none;'
  + '  }'

  + '  .bsw-table > thead > tr > th {'
  + '      border-bottom: none;'
  + '  }'


  + '  .bsw-table > thead > tr:nth-child(1) th {'
  + '      height:35px;'
  + '}'

  + '  .bsw-table > thead > tr:nth-child(2) th {'
  + '      height: 50px;'
  + '      border-bottom: 1px solid white;'
  + '  }'

  + '  .bsw-table > tbody > tr > td:nth-child(even), .bsw-table > thead > tr:nth-child(2) > th:nth-child(even) {'
  + '      border-right: dashed 1px rgba(36, 93, 113, 0.5);'
  + '      border-bottom: none;'
  + '      border-top: none;'
  + '  }'

  + '  .bsw-table th, td {'
  + '      text-align: center;'
  + '      height: 36px;'
  + '      line-height: 1.6 !important;'
  + '  }'

  + '  .bsw-table th:nth-child(1), td:nth-child(1) {'
  + '      text-align: left;'
  + '      padding-left: 25px !important;'
  + '  }'

  + '  .bsw-table > thead > tr > th:nth-child(1) {'
  + '      padding-left: 15px !important;'
  + '  }'

  + '  .bsw-table > thead > tr > th {'
  + '      font-weight: normal;'
  + '      color: #183136;'
  + '  }'

  + '  .bsw-table > thead > tr:nth-child(2) {'
  + '      font-size:12px;'
  + '  }'

  + '  .bsw-table > tbody > tr > td {'
  // +'      font-family: "Open Sans";'
  + '      font-size: 12px;'
  + '      font-weight: 400;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      line-height: normal;'
  + '      letter-spacing: normal;'
  + '      color: #4a4a4a;'
  + '  }'

  + '  .bsw-table {'
  + '      border: 1px rgba(36, 93, 113, 0.5);'
  + '      border-style: solid none solid none;'
  + '  }'

  + '  .bsw-download-text {'
  + '      line-height: 48px;'
  + '      float: right;'
  + '      margin-right: 15px;'
  + '  }'

  + '  .bsw-roboto {'
  + '      font-family: "Roboto Slab";'
  + '      font-size: 18px;'
  + '      font-weight: 300;'
  + '      font-style: normal;'
  + '      font-stretch: normal;'
  + '      line-height: 1.67;'
  + '      letter-spacing: normal;'
  + '      color: #245d71;'
  + '  }'

  + '  .bsw-hidden {'
  + '      visibility: hidden;'
  + '  }'

  + '  .bsw-visible {'
  + '      visibility: visible;'
  + '  }'

  + '  .bsw-inactive {'
  + '      display:none;'
  + '  }'

  + '  .bsw-body img.bsw-qtip {'
  + '      width: 16px;'
  + '      height: 16px;'
  + '      display: inline-block;'
  + '  }'

  + '  .bsw-body .col-md-1 img.bsw-qtip {'
  + '      float: left;'
  + '      margin: 15px 0 0 -95px;'
  + '  }'

  + '  .bsw-body .spinner {'
  + '      font-size: 0;'
  + '  }'

  + '  .bsw-body .invisible {'
  + '      visibility: hidden;'
  + '  }'

  + '  .bsw-body .x-btn.x-btn-pressed.x-btn-default-large {'
  + '      background-color: #245d71;'
  + '  }'

  + '  .bsw-body .x-btn.x-btn-pressed.x-btn-default-large span {'
  + '      color: white;'
  + '  }'

  + '  .bsw-body .x-form-trigger-wrap-default {'
  + '      border:none;'
  + '  }'

  + '  .bsw-body .x-tab-bar-default-top>.x-tab-bar-body-default {'
  + '      padding: 0;'
  + '  }'

  + '  .bsw-infobar label {'
  + '      vertical-align: top;'
  + '  }'

  + '       @page {'
  + '          margin: 0cm;'
  + '      }'


  + '  @media print {'

  + '       @page {'
  + '          margin: 1cm;'
  + '      }'

  + '      .bsw-button {'
  + '          display: none;'
  + '      }'

  + '      .x-tab {'
  + '          display: none;'
  + '          left: 0px !important;'
  + '      }'

  + '      .x-tab-active {'
  + '          display: inline;'
  + '      }'

  + '      .bsw-tabs {'
  + '           margin-bottom: 0px;'
  + '      }'

  + '      .bsw-infobar .x-component {'
  + '          width: 24%;'
  + '      }'

  + '      .bsw-select {'
  + '          width: 33%;'
  + '          float: left;'
  + '      }'

  + '      .bsw-infobar, .bsw-separator {'
  + '          margin-bottom: 0px !important;'
  + '      }'

  + '      .bsw-chartcontainer {'
  + '          margin: 40px auto 0 auto;'
  + '          width: 23%;'
  + '          float: left;'
  + '      }'

  + '      .bsw-color-legend {'
  + '          display: none;'
  + '      }'

  + '      .scrollbutton {'
  + '          display: none;'
  + '      }'

  + '      .x-panel, .x-panel div {'
  + '          border: none;'
  + '      }'

  + '      a:after {'
  + '          content:"" !important;'
  + '      }'

  + '      *::-ms-backdrop, .bsw-chartcontainer {'
  + '          margin-left: -10px;'
  + '          width: 15%;'
  + '      }'

  + '      *::-ms-backdrop, .bsw-select {'
  + '          width: 50%;'
  + '          float: left;'
  + '      }'

  + '      *::-ms-backdrop, .bsw-tabs {'
  + '           margin-bottom: 200px;'
  + '      }'

  + '      .bsw-checkbox label {'
  + '          display: none;'
  + '      }'

  + '      .x-form-cb-checked.bsw-checkbox label {'
  + '          display: inline;'
  + '      }'

  + '      .x-form-cb-checked.bsw-checkbox input {'
  + '          background: none;'
  + '      }'

  + '      .x-form-cb-checked.bsw-checkbox label {'
  + '          padding: 3px 3px 0 16px;'
  + '      }'

  + '  }'

  + '  @media screen and (max-width: 992px){'

  + '      .col-md-1 {'
  + '          width: 8.33333333% !important;'
  + '      }'

  + '      .bsw-select {'
  + '          width: 50%;'
  + '          float: left;'
  + '      }'

  + '      .bsw-infobar .x-component {'
  + '          width: 50%;'
  + '      }'

  + '      .bsw-chartcontainer {'
  + '          margin: 40px 0 0 0;'
  + '          width: 50%;'
  + '          float: left;'
  + '      }'

  + '      .bsw-secondary-header .bsw-target-header {'
  + '          width: 100%;'
  + '          margin-bottom: 20px;'
  + '      }'

  + '  }'

  + '  @media screen and (max-width: 480px) {'

  + '      .bsw-body .col-md-6, .bsw-body .col-md-4, .bsw-body .col-md-3 {'
  + '          width: 100%;'
  + '      }'

  + '      .bsw-body .col-md-1 {'
  + '          float: left;'
  + '      }'

  + '      .bsw-yearchart {'
  + '          width: 100% !important;'
  + '      }'

  + '      .bsw-infobar label {'
  + '          padding: 10px 0 20px 0;'
  + '          border-bottom: dashed 2px #3e9bbc;'
  + '      }'

  + '      .bsw-select label {'
  + '          display: none;'
  + '      }'

  + '      .bsw-color-legend {'
  + '          display: none;'
  + '      }'

  + '      .bsw-infobar {'
  + '          height: initial;'
  + '      }'

  + '      .bsw-body .invisible {'
  + '          display: none;'
  + '      }'

  + '      .bsw-body .bsw-button-group {'
  + '          width: 100%;'
  + '          float: none;'
  + '          margin: 0;;'
  + '      }'

  + '      .bsw-button-group a {'
  + '          width: 100%;'
  + '      }'

  + '      .bsw-button-group a:first-child {'
  + '          margin: 0;'
  + '      }'

  + '      .bsw-button-group > div > div {'
  + '          box-shadow: none;'
  + '          border-radius: 0;'
  + '          height: 20px;'
  + '      }'

  + '      .bsw-divider {'
  + '          display: none;'
  + '      }'

  + '      .bsw-tabs .x-tab-button span:nth-child(2) {'
  + '          max-width: 76px;'
  + '          overflow: hidden;'
  + '      }'

  + '      .bsw-body .bswtable.x-panel div {'
  + '          overflow-y: hidden;'
  + '          overflow-x: auto;'
  + '          -webkit-overflow-scrolling: touch;'
  + '      }'
  + '  }'
  , 'bsw'
);
Ext.define('Boa.model.Infobar', {
  extend: 'Ext.data.Model',
  alias: 'model.infobar',

  autoLoad: true,
  proxy: {
    type: 'ajax',
    method: 'get',
    cors: true,
    url: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/boaw-antal-registrerade-forsta-besok?apikey=KbxAwmlwLM4=&year=2015&grupptyp=landsting&gruppkod=14&completeFollowUp=0',
    reader: {
      type: 'json',
      rootProperty: 'data'
    }
  }
});

Ext.define('Boa.controller.DetailsController', {
  extend: 'Ext.app.ViewController',
  alias: 'controller.details',

  config: {
    unitsUrl: 'https://boa.registercentrum.se/stratum/api/metadata/units/register/104/',
    baseUrl: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/',
    apiKey: 'KbxAwmlwLM4=',
    comparisonGroup: 'inomlandsting'
  },

  overview: function () {
    this.redirectTo('#overview');
  },

  updateChoices: function () {
    var view = this.getView();
    this.choosenUnit = view.down('#unitFilter').getValue();
    if (this.choosenUnit !== null) {
      this.unit = this.choosenUnit.substring(1);
      this.group = this.choosenUnit.substring(0, 1) === 'R' ? 'riket' : 'enhet';
      this.group = this.choosenUnit.substring(0, 1) === 'L' ? 'landsting' : this.group;
    }
    if (typeof this.unit === 'undefined') {
      this.unit = (typeof Profile === 'undefined' || Profile.Context === null) ? 0 : Profile.Context.Unit.UnitCode;
      this.group = this.unit === 0 ? 'riket' : 'enhet';
    }

    this.indicator = view.down('#indicatorFilter').getValue();
    this.interview = view.down('#interviewFilter').getValue();
    this.sexes     = view.down('#genderFilter').getValue();
    this.ages      = view.down('#ageFilter').getValue();
    this.hip       = view.down('#hipCheckbox').getValue() === false ? 0 : 1;
    this.knee      = view.down('#kneeCheckbox').getValue() === false ? 0 : 1;
    this.hand      = view.down('#handCheckbox').getValue() === false ? 0 : 1;
    this.showStateComparison = view.down('#showStateComparison').getValue() === false ? 0 : 1;
  },

  getChoices: function () {
    return this.unit + this.group + this.indicator + this.interview + this.sexes + this.ages + this.hip + this.knee + this.hand;
  },

  updateSelection: function () {
    this.updateChoices();
    this.redirectTo('#details/' + this.indicator + '/' + this.choosenUnit + '/' + this.interview + '/' + this.sexes + '/' + this.ages + '/' + this.hip + '/' + this.knee + '/' + this. hand + '/' + this.tab);
  },

  updateStores: function () {
    var view = this.getView();
    this.updateChoices();

    if (view.down('#trendTab').isVisible()) {
      this.updateTrendStores();
    }

    if (view.down('#comparisonTab').isVisible()) {
      this.updateComparisonStores();
    }

    if (view.down('#tableTab').isVisible()) {
      this.updateTableStores();
    }

    this.updateLegend();
  },

  setSelections: function (indicator, unit, interview, gender, age, hip, knee, hand, tab) {
    this.indicator = indicator;
    this.getView().down('#indicatorFilter').setValue(indicator);
    this.unit = unit;
    this.getView().down('#unitFilter').setValue(unit);
    this.interview = interview;
    this.getView().down('#interviewFilter').setValue(interview);
    this.ages = age;
    this.getView().down('#ageFilter').setValue(age);
    this.sexes = gender;
    this.getView().down('#genderFilter').setValue(gender);
    this.hip = hip;
    this.getView().down('#hipCheckbox').setValue(hip);
    this.knee = knee;
    this.getView().down('#kneeCheckbox').setValue(knee);
    this.hand = hand;
    this.getView().down('#handCheckbox').setValue(hand);
    this.tab = tab;
    this.getView().down('#' + tab + 'Tab').show();
  },

  constructor: function () {
    this.callParent(arguments);
  },

  updateLegend: function () {
    var period;
    this.unitName = this.getView().down('#unitFilter').getRawValue();
    this.indicatorName = this.getView().down('#indicatorFilter').getRawValue();
    if (this.unitName === '') this.unitName = 'Riket';
    if (!isNaN(this.unitName)) {
      this.unitName = '';
    }

    period = (this.indicator === 'xray' || this.indicator === 'age' || this.indicator === 'no-prior-medical-joint-help') ? 'första besöket' : '1-årsuppföljning';
    period = (this.indicator === 'stop-medication' || this.indicator === 'completed-school') ? '3-månadersuppföljning' : period;

    this.getViewModel().set('legend', {
      unit: this.unitName,
      indicator: this.indicatorName,
      period: period
    });
  },

  updateTrendSelection: function () {
    this.tab = 'trend';
    this.updateSelection();
  },

  updateComparisonSelection: function () {
    this.tab = 'comparison';
    this.updateSelection();
  },

  updateTableSelection: function () {
    this.tab = 'table';
    this.updateSelection();
  },

  /*
   *    ######## ########  ######## ##    ## ########
   *       ##    ##     ## ##       ###   ## ##     ##
   *       ##    ##     ## ##       ####  ## ##     ##
   *       ##    ########  ######   ## ## ## ##     ##
   *       ##    ##   ##   ##       ##  #### ##     ##
   *       ##    ##    ##  ##       ##   ### ##     ##
   *       ##    ##     ## ######## ##    ## ########
  */

  updateTrendStores: function () {
    if (this.trendParameters === this.getChoices() + this.showStateComparison) {
      return;
    }
    if (this.trendParameters && this.trendParameters.indexOf(this.indicator) < 0) {
      this.resetCharts();
    }

    this.trendParameters = this.getChoices() + this.showStateComparison;

    if (this.indicator === 'xray' || this.indicator === 'age' || this.indicator === 'no-prior-medical-joint-help') {
      this.showGraphs(true, false, false);
      this.fetchDataForChart('ForstaPat', 'oneMonthGraph');
    } else if (this.indicator === 'stop-medication' || this.indicator === 'completed-school') {
      this.showGraphs(false, true, false);
      this.fetchDataForChart('3manPat', 'threeMonthGraph');
    } else if (this.indicator === 'eqvas' || this.indicator === 'eqindex' || this.indicator === 'pain-nrs') {
      this.showGraphs(false, true, true);
      this.fetchDataForChart('3manPat', 'threeMonthGraph');
      this.fetchDataForChart('1ArPat', 'twelveMonthGraph');
    } else {
      this.showGraphs(true, true, true);
      this.fetchDataForChart('ForstaPat', 'oneMonthGraph');
      this.fetchDataForChart('3manPat', 'threeMonthGraph');
      this.fetchDataForChart('1ArPat', 'twelveMonthGraph');
    }
  },

  fetchDataForChart: function (formType, graph) {
    var controller = this;

    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: this.getBaseUrl() + '/boaw-5year-shell?apikey=' + this.getApiKey() + '&pgm=' + this.indicator + '&visaRiket=' + this.showStateComparison + '&rinvoke=1&formulartyp=' + formType + '&grupptyp=' + this.group + '&gruppkod=' + this.unit + '&completeData=' + this.interview + '&Sex=' + this.sexes + '&ageGroup=' + this.ages + '&Hip=' + this.hip + '&Knee=' + this.knee + '&Hand=' + this.hand,
      success: function (response) {
        var result = Ext.decode(response.responseText).data;
        result.choice.output.indicator = controller.indicator;
        if (controller.unit === 0) {
          result.riket = result.choice;
        }
        if (!controller.getView()) return;
        controller.getView().down('#' + graph).updateChart(result, controller.showStateComparison);
        controller.insertIndicatorExplanation();
      }
    });
  },

  resetCharts: function () {
    var view = this.getView();
    view.down('#oneMonthGraph').resetChart();
    view.down('#threeMonthGraph').resetChart();
    view.down('#twelveMonthGraph').resetChart();
  },

  showGraphs: function (oneMonth, threeMonths, twelveMonths, period) {
    var view = this.getView();
    oneMonth     ? view.down('#oneMonthGraph').removeCls('invisible')    : view.down('#oneMonthGraph').addCls('invisible');
    threeMonths  ? view.down('#threeMonthGraph').removeCls('invisible')  : view.down('#threeMonthGraph').addCls('invisible');
    twelveMonths ? view.down('#twelveMonthGraph').removeCls('invisible') : view.down('#twelveMonthGraph').addCls('invisible');

    this.period = period;
  },

  hideAllGraphs: function () {
    var view = this.getView();
    view.down('#oneMonthGraph').hide();
    view.down('#threeMonthGraph').hide();
    view.down('#twelveMonthGraph').hide();
  },

  insertIndicatorExplanation: function () {
    var indicatorTexts = {
      'fysisk-aktivitet': ''
        + 'Indikatorn visar andelen patienter som är fysiskt aktiva minst 150 minuter per vecka. '
        + 'Målet är att minst 80 % av patienterna ska vara fysiskt aktiva 150 aktivitetsminuter eller mer per vecka ett år efter avslutad artrosskola.<br><br>'
        + 'Ungefär fem miljoner dödsfall i världen per år är direkt kopplade till fysisk inaktivitet. '
        + 'Patienter som har artros blir ofta mindre aktiva och därmed ökar risken att de ska drabbas av andra sjukdomar. '
        + 'Socialstyrelsen och Världshälsoorganisationen rekommenderar att vuxna personer är fysiskt aktiva minst 150 minuter per vecka.<br><br>'
        + 'Patienterna skattar själva antal minuter fysisk aktivitet, det vill säga kroppsrörelse som höjer pulsen något och antal minuter träning, det vill säga hårdare belastning där man blir lätt andfådd eller svettas per vecka. '
        + 'En minuts träning räknas som två aktivitetsminuter.',
      'eqvas': ''
        + 'Indikatorn mäter andelen patienter som har förbättrat sin skattade hälsa. '
        + 'Målet är att minst 30 % av patienterna ska ha angett en förbättring av sin hälsa vid uppföljningen efter ett år.<br><br>'
        + 'Här används EQ-VAS för att mäta skattad hälsa. Det är en del av instrumentet EQ5D som mäter hälsorelaterad livskvalitet. '
        + 'Man kan likna EQ-VAS vid en stående termometer som går från 0, vilket motsvarar värsta tänkbara tillstånd, till 100 som motsvarar bästa tänkbara tillstånd.<br><br>'
        + 'Ett värde ska ha höjts minst tio enheter för att räknas som förbättrat. Patienter som vid första besöket har angett 90 eller mer och förbättras kommer alltså att räknas som oförändrade. '
        + 'EQ-VAS mäts på gruppnivå och för enheter som har färre än 10 registreringar vid vald mätpunkt visas inget värde. Dessa registreringar bidrar ändå till rikets resultat. ',
      'eqindex': ''
        + 'Indikatorn mäter andelen patienter som har fått förbättrad hälsorelaterad livskvalitet. Målet är att minst 30 % av patienterna ska uppvisa en förbättrad hälsorelaterad livskvalitet vid uppföljningen efter ett år.<br><br>'
        + 'Här används instrumentet EQ5D för att mäta hälsorelaterad livskvalitet. Instrumentet har fem frågor som rör rörlighet, hygien, aktivitet, smärta och oro/nedstämdhet. Varje fråga har fem svarsalternativ som går från inga besvär till stora besvär. Dessutom ingår ett mått på skattad hälsa. Baserat på svaren räknas ett index mellan 0 och 1 fram där 0 är lika med död och 1 är lika med full hälsa.<br><br>'
        + 'Ett värde ska ha förbättrats med minst 0,1 för att det ska räknas som en förbättring. Patienter som vid första besök får värdet 0,9 eller högre och förbättras räknad därför som oförändrade.<br><br>'
        + 'EQ5D mäts på gruppnivå och för enheter som har färre än 50 registreringar vid vald mätpunkt visas inget värde. Dessa registreringar bidrar ändå till rikets resultat.',
      'pain-nrs': ''
        + 'Smärta i BOA-registret mäts med Numeric Rating Scale (NRS) där 0 står för ingen smärta och 10 står för värsta tänkbara smärta. BOA-registret använde fram till och med den 31 december 2015 en Visuell analog skala (VAS) som gick från 0-100 och införde därefter NRS. På grund av byte av mätmetod visas indikatorn endast från och med 2016.</br></br>'
        + 'Indikatorn visar andelen patienter som uppger att de har kliniskt betydelsefullt minskad smärta efter ett år. För att en förändring ska vara betydelsefull för patienten behöver den vara av en viss storlek. Minsta kliniskt betydelsefulla förbättring mätt med NRS är 2.',
      'xray': ''
        + 'Indikatorn visar andelen patienter som är röntgade innan de går artrosskola. Målet som är satt av Socialstyrelsen är att högst 50-70 % av patienterna ska vara röntgade.<br><br>'
        + 'Diagnosen artros ska enligt Socialstyrelsen och internationella riktlinjer ställas kliniskt, det vill säga med hjälp av anamnes (sjukhistoria) och en klinisk undersökning. Endast i oklara fall eller där man överväger remiss till ortoped ska röntgen vara en del av diagnostiseringen. Artrossjukdomen startar ofta 10-15 år innan förändringar syns på röntgen och röntgenfynd korrelerar dåligt med de symtom och besvär patienten har.',
      'age': ''
        + 'Indikatorn visar medelåldern på patienter som börjar artrosskola. Målet är att medelåldern ska vara högst 58 år.<br><br>'
        + 'Medelåldern på patienter i BOA-registret är hög, runt 66 år. Medelåldern för patienter som får höft- eller knäproteser inopererade är 67-70 år. Artrossjukdomen startar ofta långt innan en protesoperation är aktuell och sannolikt skulle patienterna få bäst effekt av artrosskola vid mycket lägre ålder.',
      'no-prior-medical-joint-help': ''
        + 'Indikatorn visar andelen patienter som kommer direkt till arbetsterapeut eller fysioterapeut. Målet är att minst 15 % av patienterna ska ha kommit till arbetsterapeut eller fysioterapeut direkt.<br><br>'
        + 'Grundbehandling vid artros är information, långvarig träning och vid behov viktreduktion. Enligt gällande riktlinjer ska alla som har artros erbjudas detta och patienterna kan få det hos arbetsterapeuter eller fysioterapeuter. Det krävs ingen remiss för att få tid hos arbetsterapeut eller fysioterapeut och i många regioner tillämpas även fritt vårdval när det gäller rehabilitering. Om fler patienter kom direkt till arbetsterapeut eller fysioterapeut skulle vi sannolikt nå dem tidigare i förloppet och ha större chans att hjälpa dem.',
      'stop-medication': ''
        + 'Indikatorn visar andelen patienter som slutar med ledrelaterade läkemedel efter artrosskola. Målet är att minst 30 % ska ha slutat med sådana läkemedel.<br><br>'
        + 'I många fall räcker information och anpassad fysisk aktivitet för att kontrollera smärtan vid artros. Smärtstillande läkemedel rekommenderas som komplement. I vissa fall krävs smärtstillande läkemedel för att patienten ska kunna fortsätta vara aktiv och få tillräckligt med sömn. Men många läkemedel har biverkningar och framförallt för äldre patienter som kanske även har många andra läkemedel kan biverkningarna orsaka problem. Socialstyrelsens riktlinjer säger att patienter över 75 ska förskrivas NSAID (antiinflammatoriska läkemedel) med försiktighet.',
      'completed-school': ''
        + 'Indikatorn visar andel patienter som registrerats för ett 3-månadersbesök av de som har ett första besök för respektive år. Målnivån är 80%”'
    };
    var elements = document.getElementsByClassName('bsw-indicator-explanation');

    for (var i = 0; i < elements.length; i++) {
      elements[i].innerHTML = indicatorTexts[this.indicator];
    }
  },

  /*
  *     ######   #######  ##     ## ########     ###    ########  ####  ######   #######  ##    ##
  *    ##    ## ##     ## ###   ### ##     ##   ## ##   ##     ##  ##  ##    ## ##     ## ###   ##
  *    ##       ##     ## #### #### ##     ##  ##   ##  ##     ##  ##  ##       ##     ## ####  ##
  *    ##       ##     ## ## ### ## ########  ##     ## ########   ##   ######  ##     ## ## ## ##
  *    ##       ##     ## ##     ## ##        ######### ##   ##    ##        ## ##     ## ##  ####
  *    ##    ## ##     ## ##     ## ##        ##     ## ##    ##   ##  ##    ## ##     ## ##   ###
  *     ######   #######  ##     ## ##        ##     ## ##     ## ####  ######   #######  ##    ##
  */

  updateComparisonStores: function () {
    if (this.group === 'riket') return;
    if (this.comparisonParameters === this.getChoices() + this.getComparisonGroup()) return;
    this.comparisonParameters = this.getChoices() + this.getComparisonGroup();
    this.fetchDataForRegionComparison();
  },

  fetchDataForRegionComparison: function () {
    var spinner = document.getElementsByClassName('comparison-spinner')[0];
    if (spinner) {
      spinner.classList.remove('bsw-inactive');
    }

    if (document.getElementById('exportBar')) {
      document.getElementById('exportBar').setAttribute('class', 'bsw-hidden');
    }

    this.getView().down('#comparisonChart').hide();
    var controller = this;
    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/boaw-jamfor-' + this.indicator + '?apikey=KbxAwmlwLM4=&rinvoke=1&formulartyp=ForstaPat&grupptyp=' + this.group + '&gruppkod=' + this.unit + '&completeData=' + this.interview + '&Sex=' + this.sexes + '&ageGroup=' + this.ages + '&Hip=' + this.hip + '&Knee=' + this.knee + '&Hand=' + this.hand + '&visning=' + this.getComparisonGroup(),
      success: function (response) {
        var result = Ext.decode(response.responseText).data;
        result.output.indicator = controller.indicator;
        controller.getView().down('#comparisonChart').updateChart(result.output);
        if (spinner) {
          spinner.classList.add('bsw-inactive');
        }
        controller.getView().down('#comparisonChart').show();
      }
    });
  },

  showSimilar: function (button) {
    this.setComparisonGroup('liknande');
    this.styleButtons(button);
    this.updateComparisonStores();
  },

  showRegion: function (button) {
    this.setComparisonGroup('inomlandsting');
    this.styleButtons(button);
    this.updateComparisonStores();
  },

  styleButtons: function (button) {
    var items = button.up().items.items;

    items.forEach(function (element) {
      if (element.xtype === 'panel') {
        element.addCls('bsw-divider-show');
      }
      if (element.xtype === 'button') {
        element.removeCls('bsw-active-button');
      }
    }, this);

    if (button.prev()) button.prev().removeCls('bsw-divider-show');
    if (button.next()) button.next().removeCls('bsw-divider-show');
    button.addCls('bsw-active-button');
  },

  /*
 *    ########    ###    ########  ##       ########
 *       ##      ## ##   ##     ## ##       ##
 *       ##     ##   ##  ##     ## ##       ##
 *       ##    ##     ## ########  ##       ######
 *       ##    ######### ##     ## ##       ##
 *       ##    ##     ## ##     ## ##       ##
 *       ##    ##     ## ########  ######## ########
  */

  updateTableStores: function () {
    if (this.tableParameters === this.getChoices()) return;
    this.tableParameters = this.getChoices();
    this.fetchDataForTable();
  },

  fetchDataForTable: function () {
    var controller = this;
    var spinner = document.getElementsByClassName('table-spinner')[0];
    if (spinner) {
      spinner.classList.remove('bsw-inactive');
    }

    controller.getView().down('#table').hide();

    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/boaw-tabell-' + this.indicator + '?apikey=KbxAwmlwLM4=&rinvoke=1&formulartyp=ForstaPat&grupptyp=' + this.group + '&gruppkod=' + this.unit + '&completeData=' + this.interview + '&Sex=' + this.sexes + '&ageGroup=' + this.ages + '&Hip=' + this.hip + '&Knee=' + this.knee + '&Hand=' + this.hand,
      success: function (response) {
        var result = Ext.decode(response.responseText).data;

        result.output.suffix = controller.indicator === 'age' ? ' år' : '%';
        result.output.suffix = controller.indicator === 'eqindex' || controller.indicator === 'eqvas' || controller.indicator === 'pain-nrs' ? '' : result.output.suffix;

        result.output.firstvisit   = result.output.allpatients.firstvisit   ? '' : 'bsw-inactive';
        result.output.threemonths  = result.output.allpatients.threemonths  ? '' : 'bsw-inactive';
        result.output.twelvemonths = result.output.allpatients.twelvemonths ? '' : 'bsw-inactive';

        var missingvalues = ['n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a', 'n/a'];

        if (result.output.firstvisit) {
          result.output.allpatients.firstvisit = missingvalues;
          result.output.hand.firstvisit = missingvalues;
          result.output.knee.firstvisit = missingvalues;
          result.output.hip.firstvisit = missingvalues;
        }

        if (result.output.threemonths) {
          result.output.allpatients.threemonths = missingvalues;
          result.output.hand.threemonths = missingvalues;
          result.output.knee.threemonths = missingvalues;
          result.output.hip.threemonths = missingvalues;
        }

        if (result.output.twelvemonths) {
          result.output.allpatients.twelvemonths = missingvalues;
          result.output.hand.twelvemonths = missingvalues;
          result.output.knee.twelvemonths = missingvalues;
          result.output.hip.twelvemonths = missingvalues;
        }
        if (!controller.getViewModel())controller.redirectTo('overview');
        controller.getViewModel().set('table', result.output);
        if (spinner) {
          spinner.classList.add('bsw-inactive');
        }
        controller.getView().down('#table').show();
        controller.updateExcelLink(result.output);
      }
    });
  },

  updateExcelLink: function (data) {
    var tag = document.getElementById('exportTable');
    if (!tag) return;

    var content = 'Typ av uppföljning;';
    for (var i = 0; i < data.years.length; i++) {
      content += data.years[i] + ': Antal' + ';';
      content += data.years[i] + ': Medel' + ';';
    }
    content = content + '\n';

    var areas = { allpatients: 'ALLA PATIENTER', hip: 'HÖFT', knee: 'KNÄ', hand: 'HAND' };
    var periods = { firstvisit: 'Första besök', threemonths: '3 månader', twelvemonths: '1 år' };

    for (var area in areas) {
      if (area === '') continue;
      content = content + areas[area] + '\n';
      for (var period in periods) {
        if (!data[area][period]) continue;
        content = content + periods[period] + ';';
        for (i = 0; i < data[area][period].length; i++) {
          content += data[area][period][i] + ';';
        }
        content = content + '\n';
      }
      content = content + '\n';
    }

    content = '\ufeff' + content;
    var blob = new Blob([content], { type: 'text/html;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var callback = function () {
      window.event.preventDefault();
      window.navigator.msSaveBlob(blob, 'boa-statistik.csv');
    };

    if (window.navigator.msSaveBlob) {
      tag.addEventListener('click', callback);
    } else {
      tag.setAttribute('href', url);
    }
    document.getElementById('exportTableBar').setAttribute('class', 'bsw-visible');
  }
});

Ext.define('Boa.controller.MainController', {
  extend: 'Ext.app.ViewController',
  alias: 'controller.main',

  routes: {
    '!': 'overview',
    'overview': 'overview',
    'overview/:unit/:year/:interview/:followups': 'overview',
    'details': 'details',
    'details/:indicator/:unit/:interview/:gender/:age/:hip/:knee/:hand/:tab': 'details'
  },

  overview: function (unit, year, interview, followups) {
    var view = this.getView();
    view.down('#overviewView').show();
    view.down('#detailsView').hide();
    if (unit) {
      view.down('#overviewView').getController().setSelections(unit, year, interview, followups);
    }
    view.down('#overviewView').getController().updateStores();
  },

  details: function (indicator, unit, interview, gender, age, hip, knee, hand, tab) {
    var view = this.getView();
    view.down('#overviewView').hide();
    view.down('#detailsView').show();
    if (window && window.scrollTo) {
      window.scrollTo(0, 0);
    }
    if (tab === 'undefined') this.redirectTo('#overview');
    if (indicator && unit) {
      view.down('#detailsView').getController().setSelections(indicator, unit, interview, gender, age, hip, knee, hand, tab);
    }
    view.down('#detailsView').getController().updateStores();
  },

  defaultToken: 'overview'
});

Ext.define('Boa.controller.OverviewController', {
  extend: 'Ext.app.ViewController',
  alias: 'controller.overview',

  config: {
    unitsUrl: 'https://boa.registercentrum.se/stratum/api/metadata/units/register/104/',
    baseUrl: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/',
    apiKey: 'KbxAwmlwLM4=',
    comparisonGroup: 'inomlandsting'
  },

  details: function (indicator) {
    var tab = this.getView().down('#threeMonthTab').isVisible() ? 'M3' : 'Y1';
    if (indicator) {
      var groupCode = this.group.substring(0, 1).toUpperCase();
      this.redirectTo('#details/'
        + indicator + '/'
        + groupCode + this.unit + '/'
        + tab + '/'
        + 'total/alla/1/1/1/trend');
    } else {
      this.redirectTo('#details');
    }
  },

  updateChoices: function () {
    var view = this.getView();
    this.choosenUnit = view.down('#unitFilter').getValue();
    if (this.choosenUnit !== null) {
      this.unit = this.choosenUnit.substring(1);
      this.group = this.choosenUnit.substring(0, 1) === 'R' ? 'riket' : 'enhet';
      this.group = this.choosenUnit.substring(0, 1) === 'L' ? 'landsting' : this.group;
    }
    if (typeof this.unit === 'undefined') {
      this.unit = (typeof Profile === 'undefined' || Profile.Context === null) ? 0 : Profile.Context.Unit.UnitCode;
      this.group = this.unit === 0 ? 'riket' : 'enhet';
    }
    this.year = view.down('#yearFilter').getValue();
    this.interview = view.down('#oneYearTab').isVisible() ? 'oneYear' : 'threeMonth';
    this.followups = view.down('#followups').getValue() === false ? 0 : 1;
  },

  getChoices: function () {
    return '' + this.unit + this.year + this.followups;
  },

  setSelections: function (unit, year, interview, followups) {
    this.unit = unit;
    this.getView().down('#unitFilter').setValue(unit);
    this.year = year;
    this.getView().down('#yearFilter').setValue(year);
    this.followups = followups;
    this.getView().down('#followups').setValue(followups === '1' ? true : false);
    this.getView().down('#' + interview + 'Tab').show();
  },

  updateSelection: function () {
    this.updateChoices();
    this.redirectTo('#overview/' + this.choosenUnit + '/' + this.year + '/' + this.interview + '/' + this.followups);
  },

  updateStores: function () {
    var view = this.getView();
    var currentChoices = this.getChoices();
    this.simpleGoalsLoaded = false;
    this.updateChoices();
    if (typeof this.unit === 'undefined') return;
    this.loadInfobar();

    if (view.down('#threeMonthTab').isVisible() && this.threemonthParameters !== currentChoices) {
      this.loadCircles('3manpat', { goalOne: 'fysisk-aktivitet', goalTwo: 'eq5dvas', goalThree: 'eqindex', goalFour: 'pain-nrs'});
      this.threemonthParameters = currentChoices;
    }

    if (view.down('#oneYearTab').isVisible() && this.oneyearParameters !== currentChoices ) {
      this.loadCircles('1arpat', { goalFive: 'fysisk-aktivitet', goalSix: 'eq5dvas', goalSeven: 'eqindex', goalEight: 'pain-nrs'});
      this.oneyearParameters = currentChoices;
    }

    this.clearSimpleGoals();
  },

  /**
  *    #### ##    ## ########  #######
  *     ##  ###   ## ##       ##     ##
  *     ##  ####  ## ##       ##     ##
  *     ##  ## ## ## ######   ##     ##
  *     ##  ##  #### ##       ##     ##
  *     ##  ##   ### ##       ##     ##
  *    #### ##    ## ##        #######
  */

  loadInfobar: function () {
    if (this.infobarParameters === this.getChoices()) return;
    this.infobarParameters = this.getChoices();
    var infoDefaults = {
      infobar: {
        fields: [],
        output: {
          key1: {
            toppText: 'Hämtar data',
            num: '0',
            bottomText: 'Antal registrerade patienter'
          },
          key2: {
            toppText: 'Hämtar data',
            num: '0%',
            bottomText: '0 av 0 registrerade patienter'
          },
          key3: {
            toppText: 'Hämtar data',
            num: '0%',
            bottomText: '0 av 0 registrerade patienter'
          },
          key4: {
            toppText: 'Hämtar data',
            num: '0 dagar',
            bottomText: ''
          }
        }
      }
    };

    var infoError = {
      infobar: {
        fields: [],
        output: {
          key1: {
            toppText: 'Tekniskt fel',
            num: '',
            bottomText: ''
          },
          key2: {
            toppText: 'Tekniskt fel',
            num: '',
            bottomText: ''
          },
          key3: {
            toppText: 'Tekniskt fel',
            num: '',
            bottomText: ''
          },
          key4: {
            toppText: 'Tekniskt fel',
            num: '',
            bottomText: ''
          }
        }
      }
    };

    this.infobar = this.getView().down('#infobar');
    this.infobar.getViewModel().setStores(infoDefaults);

    var controller = this;
    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: this.getBaseUrl() + 'boaw-nyckeltal?' + 'apikey=' + this.getApiKey() + '&year=' + this.year + '&grupptyp=' + this.group + '&gruppkod=' + this.unit + '&completeFollowUp=' + this.followups,
      success: function (response) {
        var result = Ext.decode(response.responseText).data;
        if (!controller.infobar.getViewModel()) return;
        controller.infobar.getViewModel().set('infobar', result);
        if (!controller.simpleGoalsLoaded) {
          controller.loadSimpleGoals();
        }
      },
      failure: function () {
        controller.infobar.getViewModel().setStores(infoError);
        if (!controller.simpleGoalsLoaded) {
          controller.loadSimpleGoals();
        }
      }
    });
  },

  /*
   *     ######  #### ########   ######  ##       ########  ######
   *    ##    ##  ##  ##     ## ##    ## ##       ##       ##    ##
   *    ##        ##  ##     ## ##       ##       ##       ##
   *    ##        ##  ########  ##       ##       ######    ######
   *    ##        ##  ##   ##   ##       ##       ##             ##
   *    ##    ##  ##  ##    ##  ##    ## ##       ##       ##    ##
   *     ######  #### ##     ##  ######  ######## ########  ######
   */

  loadCircles: function (period, goals) {
    this.checkYearChartVisibility();
    var goalDefaults = {
      goal: {
        fields: [],
        output: {
          indicatorText: 'Hämtar data',
          targetText: 'Målnivå: 0%',
          grade: 'good',
          result: 0,
          resultDescription: '',
          target: 0.8,
          valuesPerYear: {
            value1: {
              year: 2014,
              value: 0.01
            },
            value2: {
              year: 2015,
              value: 0.01
            }
          }
        }
      }
    };

    for (var goal in goals) {
      if (goal === '') continue;
      this.fetchData(period, goal, goals[goal], goalDefaults);
    }
  },

  fetchData: function (period, component, indicator, defaults) {
    var goalComponent = this.getView().down('#' + component);
    goalComponent.getViewModel().setStores(defaults);
    goalComponent.updateGoal(0);
    goalComponent.down('#goalYear').resetYear();
    var view = this.getView();
    var controller = this;
    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: this.getBaseUrl() + 'boaw-cirkel-' + indicator + '?' + 'apikey=' + this.getApiKey() + '&rinvoke=1&formulartyp=' + period + '&year=' + this.year + '&grupptyp=' + this.group + '&gruppkod=' + this.unit + '&completeFollowUp=' + this.followups,
      success: function (response) {
        var result = Ext.decode(response.responseText).data;
        if (!view.down('#' + component) || !view.down('#' + component).getViewModel()) return;
        view.down('#' + component).getViewModel().set('goal', result);
        view.down('#' + component).down('#goalYear').updateYear(result.output);
        view.down('#' + component).updateGoal(result.output.target, result.output.grade);
        if (!controller.simpleGoalsLoaded) {
          controller.loadSimpleGoals();
        }
      },
      failure: function () {
        if (!controller.simpleGoalsLoaded) {
          controller.loadSimpleGoals();
        }
      }
    });
  },

  /*
   *     ######  #### ##     ## ########  ##       ########
   *    ##    ##  ##  ###   ### ##     ## ##       ##
   *    ##        ##  #### #### ##     ## ##       ##
   *     ######   ##  ## ### ## ########  ##       ######
   *          ##  ##  ##     ## ##        ##       ##
   *    ##    ##  ##  ##     ## ##        ##       ##
   *     ######  #### ##     ## ##        ######## ########
   */

  loadSimpleGoals: function () {
    if (this.parameters === this.getChoices()) return;
    this.parameters = this.getChoices();
    this.simpleGoalsLoaded = true;
    var view = this.getView();
    var secondaryGoals = this.getView().down('#secondaryGoals');
    var year = view.down('#yearFilter').getValue();
    var followups = view.down('#followups').getValue() === false ? 0 : 1;
    var goals = {first: { indicator: 'xray', period: '3manpat' }, second: { indicator: 'age', period: ''}, third: { indicator: 'no-prior-medical-joint-help', period: 'forstapat'}, fourth: {indicator: 'stop-medication', period: '3manpat' }, fifth: {indicator: 'completed-school', period: 'forstapat'}};
    for (var goal in goals) {
      if (goal === '') continue;
      this.fetchSimpleGoal(secondaryGoals, year, goals[goal].indicator, goals[goal].period, goal, followups);
    }
  },

  clearSimpleGoals: function () {
    if (this.parameters === this.getChoices()) return;

    var defaults = {
      output: {
        grade: 'good',
        result: 0,
        indicatorText: 'Hämtar data',
        targetText: '...'
      }
    };

    var secondaryGoals = this.getView().down('#secondaryGoals');

    secondaryGoals.getViewModel().set('first', defaults);
    secondaryGoals.getViewModel().set('second', defaults);
    secondaryGoals.getViewModel().set('third', defaults);
    secondaryGoals.getViewModel().set('fourth', defaults);
    secondaryGoals.getViewModel().set('fifth', defaults);
  },

  fetchSimpleGoal: function (component, year, indicator, formType, goalNumber, followups) {
    var formTypeString = formType ? '&formulartyp=' + formType : '';
    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: this.getBaseUrl() + 'boaw-simple-' + indicator + '?' + 'apikey=' + this.getApiKey() + '&rinvoke=1' + formTypeString + '&year=' + year + '&grupptyp=' + this.group + '&gruppkod=' + this.unit + '&completeFollowUp=' + followups, success: function (response) {
        var result = Ext.decode(response.responseText).data;
        if (!component.getViewModel()) return;
        component.getViewModel().set(goalNumber, result);
      }
    });
  },

  checkYearChartVisibility: function () {
    if (this.year === 0) {
      Ext.ComponentQuery.query('#goalYear').forEach(function (year) {
        year.hide();
      });
    } else {
      Ext.ComponentQuery.query('#goalYear').forEach(function (year) {
        year.show();
      });
    }
  }
});

Ext.define('Boa.view.Comparison', {
  extend: 'Ext.chart.CartesianChart',
  xtype: 'comparison',
  alias: 'view.comparison',
  viewModel: 'details',
  controller: 'details',
  cls: 'row col-md-12',

  flipXY: true,
  // Bashöjd plus 50 x antal poster
  height: 49,

  axes: [
    {
      type: 'numeric',
      position: 'top',
      grid: false,
      dashSize: 2,
      titleMargin: 0,
      minimum: 0,
      maximum: 130,
      increment: 10,
      renderer: function (v) {
        if (v === 30) return '0%';
        if (v > 30 && v < 130 && ((v - 30) % 20) === 0) return v - 30 + '%';
        if (v > 129) return '100%       ';
        return '';
      },
      style: {
        strokeStyle: '#979797',
        majorTickSize: 0
      },
      label: {
        rotate: {
          degrees: 0
        }
      },
      limits: [{
        value: 80,
        line: {
          strokeStyle: '#009666',
          lineDash: [2, 2],
          lineWidth: 1
        }
      }]
    },
    {
      type: 'category',
      position: 'left',
      style: {
        opacity: 0.02,
        majorTickSize: 0
      },
      titleMargin: -8,
      label: {
        color: '#fff',
        font: 'Open Sans',
        fontSize: 0,
        textAlign: 'center'
      },
      fields: 'name'
    },
    {
      type: 'category',
      position: 'bottom'
    }
  ],

  series: {
    stacked: true,
    type: 'bar',
    subStyle: {
      lineWidth: 0.1,
      stroke: '#fff'
    },
    style: {
      maxBarWidth: 30
    },
    label: {
      field: 'shortname',
      display: 'insideStart',
      fill: '#183136',
      width: 300,
      renderer: function (v) {
        var label = v;
        if (label.length > 30) {
          label = label.substring(0, 30) + '...';
        }
        return label;
      }
    },
    xField: 'name',
    yField: ['base', 'value'],

    renderer: function (sprite, config, attr, index) {
      var grades = [
        'unknown',
        'bad',
        'almost',
        'good'
      ];
      var opacity = (sprite.getField() === 'base' ? 0.2 : 0.75);
      if (!attr.store.data.items[index]) return {};
      var grade = attr.store.data.items[index].get('grade');
      var value = grades.indexOf(grade);
      var color = [
        'rgba(0, 0, 0, ' + opacity + ')',
        'rgba(237, 72, 38, ' + opacity + ')',
        'rgba(251, 182, 0, ' + opacity + ')',
        'rgba(0, 150, 102, ' + opacity + ')'
      ][value];
      return {fill: color};
    },

    animation: {
      duration: 500
    },
    tooltip: {
      trackMouse: false,
      height: 28,
      defaultAlign: 'tl-tl',
      boaStyle: true,
      boaOrientation: 'left',
      anchor: 'left',
      renderer: function (record, ctx) {
        if (ctx.sprite.getField() === 'base') {
          this.setHtml(record.get('name'));
        } else {
          var prefix = record.get('indicator') === 'age' ? 'Medelålder: ' : 'Andel: ';
          var suffix = record.get('indicator') === 'age' ? ' år' : ' %';
          var value = Math.round(record.get('value'));
          this.setHtml(prefix + '<b>' + value + suffix + '</b>');
        }
      }
    }
  },

  sprites: [
    {
      type: 'line',
      x1: 3,
      y1: 113,
      x2: 1130,
      y2: 113,
      stroke: '#245d71',
      lineWidth: 1
    },
    {
      id: 'nodatasprite',
      type: 'text',
      text: 'Data saknas eller så finns färre än 10 registreringar (50 för hälsorelaterad livskvalitet)',
      x: 530,
      y: 52
    }
  ],

  store: {
    fields: ['name', 'value1', 'value2'],
    data: []
  },

  updateChart: function (output) {
    if (output.indicator === 'age') {
      this.axes[0].setRenderer(function (v) {
        if (v === 30) return '0 år';
        if (v > 30 && v < 130 && ((v - 30) % 20) === 0) return v - 30 + ' år';
        if (v > 129) return '100 år       ';
        return '';
      });
    } else {
      this.axes[0].setRenderer(function (v) {
        if (v === 30) return '0%';
        if (v > 30 && v < 130 && ((v - 30) % 20) === 0) return v - 30 + '%';
        if (v > 129) return '100%       ';
        return '';
      });
    }

    var max = output.indicator === 'age' ? 131 : 130;
    this.axes[0].setMaximum(max);

    var serverdata = output.result;

    var data = [];
    var base = 30;
    var multiplier = output.indicator !== 'age' ? 100 : 1;
    this.getItems().items[7].getItems()[1].hide();
    var shortname;
    for (var i = serverdata.length - 1; i >= 0; i--) {
      if (serverdata[i].value === 'NA' && i === 0) {
        this.getItems().items[7].getItems()[1].show();
      }
      if (serverdata[i].value !== 'NA' || i === 0) {
        if (serverdata[i].grupp.length > 25) {
          shortname = serverdata[i].grupp.substring(0, 25) + '...';
        } else {
          shortname = serverdata[i].grupp;
        }
        data.push({
          name: serverdata[i].grupp,
          shortname: shortname,
          value: serverdata[i].value * multiplier,
          grade: serverdata[i].grade,
          base: base,
          indicator: output.indicator
        });
      }
    }

    this.setHeight(50 + 40 * data.length);

    var store = {
      fields: ['name', 'value1', 'value2'],
      data: data
    };

    this.axes[0].setLimits({

      value: (output.target * multiplier) + 30,
      line: {
        strokeStyle: '#009666',
        lineDash: [2, 2],
        lineWidth: 1
      }
    });

    this.setStore(store);
    this.redraw();
    this.createExcelLink(data);
  },

  createExcelLink: function (data) {
    var tag = document.getElementById('exportComparison');
    if (!tag) return;

    var content = 'ENHET; MEDELVÄRDE;\n';
    for (var i = data.length - 1; i > 0; i--) {
      content += data[i].name + ';';
      content += Math.round(data[i].value) + ';\n';
    }
    content = '\ufeff' + content;
    var blob = new Blob([content], {
      type: 'text/csv;chartset=utf-8'
    });
    var url = URL.createObjectURL(blob);

    var callback = function () {
      window.event.preventDefault();
      window.navigator.msSaveBlob(blob, 'boa-statistik.csv');
    };

    if (window.navigator.msSaveBlob) {
      tag.addEventListener('click', callback);
    } else {
      tag.setAttribute('href', url);
    }

    document.getElementById('exportBar').setAttribute('class', 'bsw-visible');
  },

  setShowState: function (show) {
    this.showState = show;
  },

  showState: true
});

Ext.define('Boa.view.Details', {
  extend: 'Ext.container.Container',
  xtype: 'details',
  alias: 'view.details',
  controller: 'details',
  viewModel: 'details',
  cls: 'bsw-body',
  itemId: 'detailsView',
  unitsUrl: 'https://boa.registercentrum.se/stratum/api/metadata/units/register/104/',
  apiKey: 'KbxAwmlwLM4=',

  items: [
    {
      itemId: 'header',
      xtype: 'container',
      items: [
        {
          xtype: 'label',
          name: 'title',
          html: '<p>Här kan du få en inblick i hur en klinik eller en region ligger till beträffande olika indikatorer. Tänk på att datan ensamt inte är tillräcklig för att värdera en kliniks eller regions resultat utan syftar till att vara en signal till att göra vidare analyser. Statistiken innehåller endast patienter som är registrerade i BOA-registret.</p><div id="filter"></div>',
          cls: 'bsw-h1 row col-md-12'
        }
      ]
    },
    {
      itemId: 'filtercontainerUpper',
      xtype: 'container',
      cls: 'row',
      items: [
        {
          itemId: 'unitFilter',
          xtype: 'boafilter',
          cls: 'col-md-6 unitfilter',
          displayField: 'etikett',
          valueField: 'gruppkod',
          url: 'https://boa.registercentrum.se/stratum/api/metadata/units/register/104/',
          key: 'KbxAwmlwLM4=',
          value: 'R0',
          fields: ['etikett', 'gruppkod', 'grupptyp'],
          listeners: {
            select: 'updateStores'
          },
          store: { fields: [], data: {} },
          tpl: Ext.create(
            'Ext.XTemplate',
            '<tpl for=".">',
            '<div class="{[this.getClass(values)]}">{etikett}</div>',
            '</tpl>',
            {
              getClass: function (rec) {
                return rec.grupptyp === 'landsting' ? 'x-boundlist-item bsw-county-item' : 'x-boundlist-item';
              }
            }
          )
        },
        {
          xtype: 'boafilter',
          itemId: 'indicatorFilter',
          cls: 'col-md-6',
          valueField: 'IndicatorCode',
          url: '/app/data/indicators.json',
          key: 'KbxAwmlwLM4=',
          displayField: 'IndicatorName',
          value: 'fysisk-aktivitet',
          fields: ['IndicatorName', 'IndicatorCode'],
          listeners: {
            select: 'updateSelection'
          },
          store: {
            fields: ['IndicatorCode', 'IndicatorName'],
            data: [
              { IndicatorCode: 'fysisk-aktivitet', IndicatorName: 'Tillräcklig fysisk aktivitet' },
              { IndicatorCode: 'eqvas', IndicatorName: 'Skattad hälsa' },
              { IndicatorCode: 'eqindex', IndicatorName: 'Hälsorelaterad livskvalitet' },
              { IndicatorCode: 'pain-nrs', IndicatorName: 'Skattad smärta' },

              { IndicatorCode: 'xray', IndicatorName: 'Andel röntgade innan artrosskola' },
              { IndicatorCode: 'age', IndicatorName: 'Medelålder' },
              { IndicatorCode: 'no-prior-medical-joint-help', IndicatorName: 'Andel som söker direkt' },

              { IndicatorCode: 'stop-medication', IndicatorName: 'Slutar med ledrelaterade läkemedel' },
              { IndicatorCode: 'completed-school', IndicatorName: 'Andel uppföljda efter artrosskola' }
            ]
          }
        }
      ]
    },
    {
      itemId: 'filterText',
      xtype: 'container',
      html: 'Urval:   <img class="bsw-qtip" style="margin-bottom: 3px;" src="https://registercentrum.blob.core.windows.net/boa/r/Utdata-info-BJgYkJMKx.png" data-qtip="Välj patienter med uppgifter från första besök, 3-månadersuppföljning eller 1-årsuppföljning">'
    },
    {
      xtype: 'container',
      itemId: 'filtercontainerLower',
      cls: 'row',
      items: [
        {
          itemId: 'interviewFilter',
          xtype: 'boafilter',
          cls: 'col-md-3',
          valueField: 'InterviewCode',
          url: '/app/data/interviews.json',
          key: 'KbxAwmlwLM4=',
          displayField: 'InterviewName',
          value: 'FV',
          fields: ['InterviewName', 'InterviewCode'],
          listeners: {
            select: 'updateSelection'
          },
          store: {
            fields: ['InteviewCode', 'InterviewName'],
            data: [
              { InterviewCode: 'FV', InterviewName: 'Alla med första besök' },
              { InterviewCode: 'M3', InterviewName: 'Alla med 3-månadersuppföljning' },
              { InterviewCode: 'Y1', InterviewName: 'Alla med 1-årsuppföljning' }
            ]
          }
        },
        {
          itemId: 'genderFilter',
          xtype: 'boafilter',
          cls: 'col-md-3',
          valueField: 'GenderCode',
          url: '/app/data/genders.json',
          key: 'KbxAwmlwLM4=',
          displayField: 'GenderName',
          value: 'total',
          fields: ['GenderName', 'GenderCode'],
          listeners: {
            select: 'updateSelection'
          },
          store: {
            fields: ['GenderCode', 'GenderName'],
            data: [
              { GenderCode: 'total', GenderName: 'Kvinnor och män' },
              { GenderCode: 'female', GenderName: 'Kvinnor' },
              { GenderCode: 'male', GenderName: 'Män' }
            ]
          }
        },
        {
          itemId: 'ageFilter',
          xtype: 'boafilter',
          cls: 'col-md-3',
          valueField: 'AgeCode',
          url: '/app/data/ages.json',
          key: 'KbxAwmlwLM4=',
          displayField: 'AgeName',
          value: 'alla',
          fields: ['AgeName', 'AgeCode'],
          listeners: {
            select: 'updateSelection'
          },
          store: {
            fields: ['AgeCode', 'AgeName'],
            data: [
              { AgeCode: 'alla', AgeName: 'Alla åldrar' },
              { AgeCode: 'under65', AgeName: 'Under 65' },
              { AgeCode: 'over65', AgeName: '65 år eller över' }
            ]
          }
        },
        {
          xtype: 'checkbox',
          name: 'hip',
          value: 1,
          uncheckedValue: '0',
          itemId: 'hipCheckbox',
          boxLabel: 'Höft',
          cls: 'col-md-1 bsw-checkbox',
          listeners: {
            change: 'updateSelection'
          }
        },
        {
          xtype: 'checkbox',
          name: 'knee',
          value: 1,
          id: 'kneeCheckbox',
          boxLabel: 'Knä',
          cls: 'col-md-1 bsw-checkbox',
          listeners: {
            change: 'updateSelection'
          }
        },
        {
          xtype: 'checkbox',
          name: 'hand',
          value: 1,
          id: 'handCheckbox',
          boxLabel: 'Hand',
          cls: 'col-md-1 bsw-checkbox',
          listeners: {
            change: 'updateSelection'
          }
        }

      ]
    },
    {
      itemId: 'detailsTabs',
      xtype: 'tabpanel',
      cls: 'bsw-tabs',
      items: [
        {
          itemId: 'trendTab',
          title: 'TREND 5 ÅR',
          items: [
            {
              xtype: 'container',
              name: 'title',
              bind: {
                html: '<div class="bsw-chart-title"><h2>5-ÅRSTREND FÖR {legend.indicator}</h2></div><div class="bsw-trend-legend"><div class="bsw-circle bsw-color-seafoam pull-left"></div><span class="pull-left bsw-details-legend">{legend.unit}</span><div class="pull-left bsw-circle bsw-color-dark-slate"></div><span class="pull-left bsw-details-legend">Riket</span></div>'
              },
              cls: 'bsw-header'
            },
            {
              xtype: 'container',
              cls: 'bsw-checkbox-row',
              items: [
                {
                  xtype: 'container',
                  cls: 'bsw-box-group',
                  items: [
                    {
                      xtype: 'checkbox',
                      name: 'showstate',
                      value: 0,
                      itemId: 'showStateComparison',
                      boxLabel: 'Visa Riket',
                      cls: 'bsw-checkbox',
                      listeners: {
                        change: 'updateStores'
                      }
                    }
                  ]
                }
              ]
            },
            {
              xtype: 'container',
              items: [
                {
                  xtype: 'trend',
                  itemId: 'oneMonthGraph',
                  title: 'FÖRSTA BESÖK',
                  showState: true
                },
                {
                  xtype: 'trend',
                  itemId: 'threeMonthGraph',
                  title: '3-MÅNADERSUPPFÖLJNING'
                },
                {
                  xtype: 'trend',
                  itemId: 'twelveMonthGraph',
                  title: '1-ÅRSUPPFÖLJNING'
                }
              ]
            },
            {
              xtype: 'container',
              name: 'title',
              bind: {
                html: '<div class="bsw-subscript col-md-12">*Texten "ingen data" visas om data saknas eller om det finns färre än 10 registreringar (50 för hälsorelaterad livskvalitet)</div><div class="col-md-5"><h2>OM INDIKATORN</h2><p class="bsw-indicator-explanation"></p></div>'
              },
              cls: 'bsw-header'
            }
          ],
          listeners: {
            show: 'updateTrendSelection'
          }
        },
        {
          itemId: 'comparisonTab',
          title: 'JÄMFÖR',
          cls: 'bsw-compare',
          items: [
            {
              xtype: 'container',
              name: 'title',
              bind: {
                html: '<div class="bsw-chart-title"><h2>{legend.indicator}</h2></div><p>Här ser du en jämförelse mellan mottagningar eller mellan landsting hur väl de når målet för indikatorn. Datan är beräknad på de senaste 12 månaderna. Du väljer mellan att visa en jämförelse mellan enheter inom samma landsting eller en jämförelse mellan landstingen alternativt enheter/landsting med liknande patientsammansättning <img class="bsw-qtip" src="https://registercentrum.blob.core.windows.net/boa/r/Utdata-info-BJgYkJMKx.png" data-qtip="Här jämförs enheter eller landsting med liknande casemix, dvs de som är mest lika avseende andel över 65 år, andel män, andel på väntelista till operation, andel patienter som har besvär från tre eller fler ledsystem samt andel som uppger att de har gångsvårigheter av andra orsaker än ledbesvär.">.</p><p>Indikatorn visar måluppfyllnad vid {legend.period}.</p></div'

              },
              cls: 'bsw-header'
            },
            {
              xtype: 'container',
              cls: 'bsw-compare-navigation',
              items: [
                {
                  xtype: 'container',
                  html: '<div><span>Målet inte uppfyllt</span><span>Målet nästan uppfyllt</span><span>Målet uppfyllt</span></div>',
                  cls: 'bsw-color-legend'
                },
                {
                  xtype: 'container',
                  cls: 'bsw-button-group',
                  items: [
                    {
                      xtype: 'button',
                      text: 'Inom samma landsting',
                      cls: 'bsw-active-button',
                      listeners: {
                        click: 'showRegion'
                      }
                    },
                    {
                      cls: 'bsw-divider',
                      html: '<div></div>'
                    },
                    {
                      xtype: 'button',
                      text: 'Liknande patientsammansättning',
                      listeners: {
                        click: 'showSimilar'
                      }
                    }
                  ]

                }
              ]
            },
            {
              xtype: 'comparison',
              itemId: 'comparisonChart',
              cls: 'bsw-comparison-chart',
              hidden: true
            },
            {
              html:
                '<div class="col-md-12 comparison-spinner bsw-inactive">'
                + '    <div class="spinner">'
                + '        <div class="rect1"></div>'
                + '        <div class="rect2"></div>'
                + '        <div class="rect3"></div>'
                + '        <div class="rect4"></div>'
                + '        <div class="rect5"></div>'
                + '    </div>'
                + '</div>'
            },
            {
              bind: {
                html: '<div id="exportBar" class="bsw-hidden"><a class="btn btn-default bsw-roboto pull-right" id="exportComparison" href="" download="{legend.indicator}.csv">EXCEL</a><span class="bsw-download-text">Ladda ner </span></div>'
              }
            }
          ],
          listeners: {
            show: 'updateComparisonSelection'
          }
        },
        {
          itemId: 'tableTab',
          title: 'TABELL',
          items: [
            {
              xtype: 'container',
              name: 'title',
              bind: {
                html: '<div class="bsw-chart-title"><h2>{legend.indicator}</h2>'
                  + '<p>Med antal avses antal patienter som besvarat frågan.</p>'
                  + '<p><p>Med medel/andel avses olika saker för respektive indikator. För skattad hälsa visas medelvärdet av EQ5D-VAS för respektive besök, för hälsorelaterad livskvalitet visas EQ5D-index och för skattad smärta visas medelvärdet av NRS.</p</div>'
              },
              cls: 'bsw-header'
            },
            {
              cls: 'bswtable',
              itemId: 'table',
              bind: {
                html: '<table id="table" class="bsw-table table">'
                  + '    <thead>                       '
                  + '      <tr>'
                  + '        <th colspan="2"></th><th colspan="2">{table.years.0}</th><th colspan="2">{table.years.1}</th><th colspan="2">{table.years.2}</th><th colspan="2">{table.years.3}</th><th colspan="2">{table.years.4}</th>' + '        <th colspan="2">{table.years.5}</th>'
                  + '      </tr>'
                  + '      <tr>'
                  + '        <th colspan="2">Typ av uppföljning</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th>'
                  + '      </tr>'
                  + '    </thead>'
                  + '    <tbody>'
                  + '      <tr>'
                  + '         <td colspan="2">ALLA PATIENTER</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
                  + '      </tr>'
                  + '      <tr class="{table.firstvisit}">'
                  + '         <td colspan="2">Första besök</td><td>{table.allpatients.firstvisit.0}</td><td>{table.allpatients.firstvisit.1}{table.suffix}</td><td>{table.allpatients.firstvisit.2}</td><td>{table.allpatients.firstvisit.3}{table.suffix}</td><td>{table.allpatients.firstvisit.4}</td><td>{table.allpatients.firstvisit.5}{table.suffix}</td><td>{table.allpatients.firstvisit.6}</td><td>{table.allpatients.firstvisit.7}{table.suffix}</td><td>{table.allpatients.firstvisit.8}</td><td>{table.allpatients.firstvisit.9}{table.suffix}</td><td>{table.allpatients.firstvisit.10}</td><td>{table.allpatients.firstvisit.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.threemonths}">'
                  + '         <td colspan="2">3 månader</td><td>{table.allpatients.threemonths.0}</td><td>{table.allpatients.threemonths.1}{table.suffix}</td><td>{table.allpatients.threemonths.2}</td><td>{table.allpatients.threemonths.3}{table.suffix}</td><td>{table.allpatients.threemonths.4}</td><td>{table.allpatients.threemonths.5}{table.suffix}</td><td>{table.allpatients.threemonths.6}</td><td>{table.allpatients.threemonths.7}{table.suffix}</td><td>{table.allpatients.threemonths.8}</td><td>{table.allpatients.threemonths.9}{table.suffix}</td><td>{table.allpatients.threemonths.10}</td><td>{table.allpatients.threemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.twelvemonths}">'
                  + '         <td colspan="2">1 år</td><td>{table.allpatients.twelvemonths.0}</td><td>{table.allpatients.twelvemonths.1}{table.suffix}</td><td>{table.allpatients.twelvemonths.2}</td><td>{table.allpatients.twelvemonths.3}{table.suffix}</td><td>{table.allpatients.twelvemonths.4}</td><td>{table.allpatients.twelvemonths.5}{table.suffix}</td><td>{table.allpatients.twelvemonths.6}</td><td>{table.allpatients.twelvemonths.7}{table.suffix}</td><td>{table.allpatients.twelvemonths.8}</td><td>{table.allpatients.twelvemonths.9}{table.suffix}</td><td>{table.allpatients.twelvemonths.10}</td><td>{table.allpatients.twelvemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '     <tr>'
                  + '         <td colspan="2">HÖFT</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
                  + '      </tr>'
                  + '      <tr class="{table.firstvisit}">'
                  + '         <td colspan="2">Första besök</td><td>{table.hip.firstvisit.0}</td><td>{table.hip.firstvisit.1}{table.suffix}</td><td>{table.hip.firstvisit.2}</td><td>{table.hip.firstvisit.3}{table.suffix}</td><td>{table.hip.firstvisit.4}</td><td>{table.hip.firstvisit.5}{table.suffix}</td><td>{table.hip.firstvisit.6}</td><td>{table.hip.firstvisit.7}{table.suffix}</td><td>{table.hip.firstvisit.8}</td><td>{table.hip.firstvisit.9}{table.suffix}</td><td>{table.hip.firstvisit.10}</td><td>{table.hip.firstvisit.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.threemonths}">'
                  + '         <td colspan="2">3 månader</td><td>{table.hip.threemonths.0}</td><td>{table.hip.threemonths.1}{table.suffix}</td><td>{table.hip.threemonths.2}</td><td>{table.hip.threemonths.3}{table.suffix}</td><td>{table.hip.threemonths.4}</td><td>{table.hip.threemonths.5}{table.suffix}</td><td>{table.hip.threemonths.6}</td><td>{table.hip.threemonths.7}{table.suffix}</td><td>{table.hip.threemonths.8}</td><td>{table.hip.threemonths.9}{table.suffix}</td><td>{table.hip.threemonths.10}</td><td>{table.hip.threemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.twelvemonths}">'
                  + '         <td colspan="2">1 år</td><td>{table.hip.twelvemonths.0}</td><td>{table.hip.twelvemonths.1}{table.suffix}</td><td>{table.hip.twelvemonths.2}</td><td>{table.hip.twelvemonths.3}{table.suffix}</td><td>{table.hip.twelvemonths.4}</td><td>{table.hip.twelvemonths.5}{table.suffix}</td><td>{table.hip.twelvemonths.6}</td><td>{table.hip.twelvemonths.7}{table.suffix}</td><td>{table.hip.twelvemonths.8}</td><td>{table.hip.twelvemonths.9}{table.suffix}</td><td>{table.hip.twelvemonths.10}</td><td>{table.hip.twelvemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '     <tr>'
                  + '         <td colspan="2">KNÄ</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
                  + '      </tr>'
                  + '      <tr class="{table.firstvisit}">'
                  + '         <td colspan="2">Första besök</td><td>{table.knee.firstvisit.0}</td><td>{table.knee.firstvisit.1}{table.suffix}</td><td>{table.knee.firstvisit.2}</td><td>{table.knee.firstvisit.3}{table.suffix}</td><td>{table.knee.firstvisit.4}</td><td>{table.knee.firstvisit.5}{table.suffix}</td><td>{table.knee.firstvisit.6}</td><td>{table.knee.firstvisit.7}{table.suffix}</td><td>{table.knee.firstvisit.8}</td><td>{table.knee.firstvisit.9}{table.suffix}</td><td>{table.knee.firstvisit.10}</td><td>{table.knee.firstvisit.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.threemonths}">'
                  + '         <td colspan="2">3 månader</td><td>{table.knee.threemonths.0}</td><td>{table.knee.threemonths.1}{table.suffix}</td><td>{table.knee.threemonths.2}</td><td>{table.knee.threemonths.3}{table.suffix}</td><td>{table.knee.threemonths.4}</td><td>{table.knee.threemonths.5}{table.suffix}</td><td>{table.knee.threemonths.6}</td><td>{table.knee.threemonths.7}{table.suffix}</td><td>{table.knee.threemonths.8}</td><td>{table.knee.threemonths.9}{table.suffix}</td><td>{table.knee.threemonths.10}</td><td>{table.knee.threemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.twelvemonths}">'
                  + '         <td colspan="2">1 år</td><td>{table.knee.twelvemonths.0}</td><td>{table.knee.twelvemonths.1}{table.suffix}</td><td>{table.knee.twelvemonths.2}</td><td>{table.knee.twelvemonths.3}{table.suffix}</td><td>{table.knee.twelvemonths.4}</td><td>{table.knee.twelvemonths.5}{table.suffix}</td><td>{table.knee.twelvemonths.6}</td><td>{table.knee.twelvemonths.7}{table.suffix}</td><td>{table.knee.twelvemonths.8}</td><td>{table.knee.twelvemonths.9}{table.suffix}</td><td>{table.knee.twelvemonths.10}</td><td>{table.knee.twelvemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '     <tr>'
                  + '         <td colspan="2">HAND</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
                  + '      </tr>'
                  + '      <tr class="{table.firstvisit}">'
                  + '         <td colspan="2">Första besök</td><td>{table.hand.firstvisit.0}</td><td>{table.hand.firstvisit.1}{table.suffix}</td><td>{table.hand.firstvisit.2}</td><td>{table.hand.firstvisit.3}{table.suffix}</td><td>{table.hand.firstvisit.4}</td><td>{table.hand.firstvisit.5}{table.suffix}</td><td>{table.hand.firstvisit.6}</td><td>{table.hand.firstvisit.7}{table.suffix}</td><td>{table.hand.firstvisit.8}</td><td>{table.hand.firstvisit.9}{table.suffix}</td><td>{table.hand.firstvisit.10}</td><td>{table.hand.firstvisit.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.threemonths}">'
                  + '         <td colspan="2">3 månader</td><td>{table.hand.threemonths.0}</td><td>{table.hand.threemonths.1}{table.suffix}</td><td>{table.hand.threemonths.2}</td><td>{table.hand.threemonths.3}{table.suffix}</td><td>{table.hand.threemonths.4}</td><td>{table.hand.threemonths.5}{table.suffix}</td><td>{table.hand.threemonths.6}</td><td>{table.hand.threemonths.7}{table.suffix}</td><td>{table.hand.threemonths.8}</td><td>{table.hand.threemonths.9}{table.suffix}</td><td>{table.hand.threemonths.10}</td><td>{table.hand.threemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '      <tr class="{table.twelvemonths}">'
                  + '         <td colspan="2">1 år</td><td>{table.hand.twelvemonths.0}</td><td>{table.hand.twelvemonths.1}{table.suffix}</td><td>{table.hand.twelvemonths.2}</td><td>{table.hand.twelvemonths.3}{table.suffix}</td><td>{table.hand.twelvemonths.4}</td><td>{table.hand.twelvemonths.5}{table.suffix}</td><td>{table.hand.twelvemonths.6}</td><td>{table.hand.twelvemonths.7}{table.suffix}</td><td>{table.hand.twelvemonths.8}</td><td>{table.hand.twelvemonths.9}{table.suffix}</td><td>{table.hand.twelvemonths.10}</td><td>{table.hand.twelvemonths.11}{table.suffix}</td>'
                  + '      </tr>'
                  + '    </tbody>'
                  + '  </table>'
              }
            },
            {
              html: ''

                + '<div class="col-md-12 table-spinner bsw-inactive">'
                + '    <div class="spinner">'
                + '        <div class="rect1"></div>'
                + '        <div class="rect2"></div>'
                + '        <div class="rect3"></div>'
                + '        <div class="rect4"></div>'
                + '        <div class="rect5"></div>'
                + '    </div>'
                + '</div>'
            },
            {
              xtype: 'container',
              name: 'title',
              bind: {
                html: '<div class="bsw-subscript col-md-12">*NA innebär att data saknas eller att det finns färre än 10 registreringar (50 för hälsorelaterad livskvalitet).</div><div class="col-md-5"></div>'
                  + '<div id="exportTableBar" class="bsw-hidden"><a class="btn btn-default bsw-roboto pull-right" id="exportTable" href="" download="boa-statistik.csv">EXCEL</a><span class="bsw-download-text">Ladda ner </span></div>'
              },
              cls: 'bsw-header'
            }
          ],
          listeners: {
            show: 'updateTableSelection'
          }
        }
      ]
    }
  ]
});

Ext.define('Boa.view.DetailsModel', {
  extend: 'Ext.app.ViewModel',
  alias: 'viewmodel.details',
  stores: {
    legend: {
      fields: [],
      unit: 'foo'
    },
    table: {
      fields: []
    }
  },

  formulas: {
    firstresult: function (get) {
      return Math.round(100 * get('first.output.result'));
    },
    secondresult: function (get) {
      return Math.round(100 * get('second.output.result'));
    },
    thirdresult: function (get) {
      return Math.round(100 * get('third.output.result'));
    }
  }
});

Ext.define('Boa.view.Filter', {
  extend: 'Ext.form.field.ComboBox',
  xtype: 'boafilter',
  alias: 'view.boafilter',
  forceSelection: false,
  typeAhead: true,
  queryMode: 'local',
  minChars: 1,
  anyMatch: true,
  autoSelect: false,
  caseSensitive: false,
  checkChangeEvents: ['change', 'keyup'],

  constructor: function (config) {
    config.store = config.store ? config.store : {
      fields: config.fields,
      autoLoad: true,
      proxy: {
        type: 'ajax',
        method: 'get',
        cors: true,
        url: config.url,
        extraParams: {
          apiKey: config.key
        },
        reader: {
          type: 'json',
          rootProperty: 'data'
        }
      },
      sortdirection: config.sortdirection,
      sortfield: config.sortfield,

      listeners: {
        load: config.addFieldsCallback
      }
    };
    config.cls = 'bsw-select ' + config.cls;
    config.queryMode = 'local';
    this.callParent(arguments);
  }
});

Ext.define('Boa.view.GoalYear', {
  extend: 'Ext.chart.CartesianChart',
  xtype: 'goalYear',
  alias: 'view.goalYear',
  controller: 'overview',
  viewModel: 'primarygoal',
  cls: 'bsw-yearchart bsw-chart-no-bar',

  goal: 100,
  width: 240,
  height: 160,

  store: {
    fields: ['name', 'value'],
    data: [
      {
        name: '',
        value: 0.01,
        grade: 'none'
      },
      {
        name: '   ',
        value: 0.01,
        grade: 'bad'
      },
      {
        name: '  ',
        value: 0.01,
        grade: 'bad'
      },
      {
        name: '    ',
        value: 0.01,
        grade: 'none'
      }
    ]
  },

  axes: [
    {
      type: 'numeric',
      position: 'left',

      grid: true,
      dashSize: 0,
      minimum: 0,
      maximum: 1,
      style: {
        strokeStyle: '#fff',
        majorTickSize: 0
      },
      label: {
        color: 'white',
        rotate: {
          degrees: -45
        }
      },
      limits: [{
        value: 0.5,
        line: {
          strokeStyle: '#009666',
          lineDash: [4, 3],
          lineWidth: 2
        }
      }]
    },
    {
      type: 'category',
      position: 'bottom',
      style: { opacity: 0.2, majorTickSize: 0 },
      title: {
        text: '',
        fontSize: 15
      },
      label: {
        color: '#183136',
        font: 'Open Sans',
        fontSize: 12,
        textAlign: 'center'
      },
      cls: 'foo',
      fields: 'name'
    }
  ],

  series: {
    type: 'bar',
    subStyle: {
      stroke: '#fff'
    },

    xField: 'name',
    yField: 'value',

    renderer: function (sprite, record, attr, index) {
      var grades = [
        'none',
        'bad',
        'almost',
        'good'
      ];

      var grade = attr.store.data.items[index].get('grade');
      var value = grades.indexOf(grade);
      var color = [
        'rgba(255, 255, 255, 0)',
        'rgb(237, 72, 38)',
        'rgb(251, 182, 0)',
        'rgb(0, 150, 102)'
      ][value];
      if (index === 1) color = 'rgb(221,221,221)';
      return Ext.apply(attr, {
        fill: color
      });
    },
    animation: {
      duration: 500
    },
    tooltip: {
      trackMouse: false,
      height: 28,
      defaultAlign: 'tl-tl',
      boaStyle: true,
      boaWidth: 40,
      anchor: 'bottom',

      renderer: function (record, ctx) {
        if (ctx.index !== 0) {
          this.setHtml(Math.round(record.get('value') * 100) + '%');
        }
      }
    }
  },

  updateYear: function (output) {
    var store = {
      fields: ['name', 'value'],
      data: [
        {
          name: '',
          value: 0.01,
          grade: 'none'
        },
        {
          name: output.valuesPerYear.value1.year,
          value: output.valuesPerYear.value1.value,
          grade: 'none'
        },
        {
          name: output.valuesPerYear.value2.year,
          value: output.valuesPerYear.value2.value,
          grade: output.grade
        },
        {
          name: ' ',
          value: 0.01,
          grade: 'none'
        }
      ]
    };

    this.axes[0].setLimits({
      value: output.target,
      line: {
        strokeStyle: '#009666',
        lineDash: [4, 3],
        lineWidth: 2
      }
    });
    this.setStore(store);
    this.redraw();
  },

  resetYear: function () {
    if (this.getStore().getAt(2)) {
      this.getStore().getAt(1).set('value', 0.01);
      this.getStore().getAt(1).set('name', '  ');
      this.getStore().getAt(2).set('value', 0.01);
      this.getStore().getAt(2).set('name', '   ');
    }
    this.axes[0].setLimits({
      value: 0.01,
      line: {
        strokeStyle: '#009666',
        lineDash: [4, 3],
        lineWidth: 2
      }
    });
  }
});

Ext.define('Boa.view.Infobar', {
  extend: 'Ext.container.Container',
  xtype: 'infobar',
  alias: 'view.infobar',
  viewModel: 'infobar',
  cls: 'bsw-infobar',

  items: [
    {
      xtype: 'label',
      bind: {
        html: '<div>{infobar.output.key1.toppText}</div><div>{infobar.output.key1.num}</div><div>{infobar.output.key1.bottomText}</div>'
      },
      cls: 'col-md-3'
    },
    {
      xtype: 'label',
      bind: {
        html: '<div>{infobar.output.key2.toppText}</div><div>{infobar.output.key2.num}</div><div>{infobar.output.key2.bottomText}</div>'
      },
      cls: 'col-md-3'
    },
    {
      xtype: 'label',
      bind: {
        html: '<div>{infobar.output.key3.toppText}</div><div>{infobar.output.key3.num}</div><div>{infobar.output.key3.bottomText}</div>'
      },
      cls: 'col-md-3'
    },
    {
      xtype: 'label',
      bind: {
        html: '<div>{infobar.output.key4.toppText}</div><div>{infobar.output.key4.num}</div><div>{infobar.output.key4.bottomText}</div>'
      },
      cls: 'col-md-3'
    }
  ]
});

Ext.define('Boa.view.InfobarModel', {
  extend: 'Ext.app.ViewModel',
  alias: 'viewmodel.infobar',

  stores: {
    infobar: {
      fields: [],
      output: {
        key1: {
          toppText: 'Hämtar data',
          num: '0',
          bottomText: 'Antal registrerade patienter'
        },
        key2: {
          toppText: 'Hämtar data',
          num: '0%',
          bottomText: '0 av 0 registrerade patienter'
        },
        key3: {
          toppText: 'Hämtar data',
          num: '0%',
          bottomText: '0 av 0 registrerade patienter'
        },
        key4: {
          toppText: 'Hämtar data',
          num: '0 dagar',
          bottomText: 'Antal dagar till 3-månadersuppföljning'
        }
      }
    }
  }
});

Ext.define('Boa.view.Main', {
  extend: 'Ext.container.Container',
  controller: 'main',
  id: 'BoaMain',
  items: [{
    xtype: 'overview',
    hidden: true

  },
  {
    xtype: 'details',
    hidden: true
  }]
});

Ext.define('Boa.view.OverView', {
  extend: 'Ext.container.Container',
  alias: 'widget.overview',
  controller: 'overview',
  itemId: 'overviewView',

  constructor: function (config) {
    var header = {
      xtype: 'container',
      itemId: 'header',
      items: [{
        xtype: 'label',
        name: 'title',
        html: '<p>Här kan du få en inblick i hur en klinik eller en region ligger till beträffande olika indikatorer. Tänk på att datan ensamt inte är tillräcklig för att värdera en kliniks eller regions resultat utan syftar till att vara en signal till att göra vidare analyser. Statistiken innehåller endast patienter som är registrerade i BOA-registret.</p>',
        cls: 'bsw-h1 row col-md-12'
      }]
    };

    var filters = {
      xtype: 'container',
      itemId: 'filters',
      cls: 'row',
      items: [
        {
          xtype: 'boafilter',
          itemId: 'unitFilter',
          displayField: 'etikett',
          valueField: 'gruppkod',
          cls: 'col-md-4',
          url: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/boaw-choices-riket-landsting-enhet?rinvoke=1&',
          key: 'KbxAwmlwLM4=',
          fields: ['etikett', 'gruppkod', 'grupptyp'],
          listeners: {
            select: 'updateSelection'
          },
          store: { fields: [], data: {} },
          tpl: Ext.create(
            'Ext.XTemplate',
            '<tpl for=".">',
            '<div class="{[this.getClass(values)]}">{etikett}</div>',
            '</tpl>',
            {
              getClass: function (rec) {
                return rec.grupptyp === 'landsting' ? 'x-boundlist-item bsw-county-item' : 'x-boundlist-item';
              }
            }
          )
        },
        {
          xtype: 'boafilter',
          itemId: 'yearFilter',
          displayField: 'YearName',
          valueField: 'YearCode',
          cls: 'col-md-4',
          url: '',
          key: 'KbxAwmlwLM4=',
          value: 0,
          sortfield: 'YearName',
          sortdirection: 'DESC',
          fields: ['YearName', 'YearCode'],
          fieldLabel: 'Första besök',
          addFieldsCallback: function (store) {
            var defaultUnit = { YearCode: 0, YearName: 'Alla år' };
            store.insert(0, defaultUnit);
            store.sort('YearName', 'DESC');
          },
          listeners: {
            select: 'updateSelection'
          },
          store: {
            fields: ['YearCode', 'YearName'],
            data: [
              { YearCode: 0, YearName: 'Alla år' },
              { YearCode: 2018, YearName: 2018 },
              { YearCode: 2017, YearName: 2017 },
              { YearCode: 2016, YearName: 2016 },
              { YearCode: 2015, YearName: 2015 },
              { YearCode: 2014, YearName: 2014 },
              { YearCode: 2013, YearName: 2013 },
              { YearCode: 2012, YearName: 2012 },
              { YearCode: 2011, YearName: 2011 }
            ]
          }
        },
        {
          xtype: 'checkbox',
          name: 'allfollowups',
          inputValue: 0,
          id: 'checkbox1',
          itemId: 'followups',
          boxLabel: 'Endast uppföljda patienter <div class="bsw-info" data-qtip="Bocka i här för att visa patienter som har uppgifter från första besök samt både 3-månadersuppföljning och 1-årsuppföljning."><div>i</div></div>',
          cls: 'col-md-3 bsw-checkbox',
          listeners: {
            change: 'updateSelection'
          }
        }
      ]
    };

    var infobar = {
      xtype: 'infobar',
      itemId: 'infobar'
    };

    var tabs = {
      xtype: 'tabpanel',
      itemId: 'tabs',
      cls: 'bsw-tabs',
      items: [
        {
          title: '3-MÅNADERSUPPFÖLJNING',
          itemId: 'threeMonthTab',
          items: [
            {
              xtype: 'primarygoal',
              itemId: 'goalOne',
              link: 'fysisk-aktivitet'
            },
            {
              xtype: 'primarygoal',
              itemId: 'goalTwo',
              link: 'eqvas'
            },
            {
              xtype: 'primarygoal',
              itemId: 'goalThree',
              link: 'eqindex'
            },
            {
              xtype: 'primarygoal',
              itemId: 'goalFour',
              link: 'pain-nrs'
            }
          ],
          listeners: {
            show: 'updateSelection'
          }
        },
        {
          title: '1-ÅRSUPPFÖLJNING',
          itemId: 'oneYearTab',
          items: [
            {
              xtype: 'primarygoal',
              itemId: 'goalFive',
              link: 'fysisk-aktivitet'
            },
            {
              xtype: 'primarygoal',
              itemId: 'goalSix',
              link: 'eqvas'
            },
            {
              xtype: 'primarygoal',
              itemId: 'goalSeven',
              link: 'eqindex'
            },
            {
              xtype: 'primarygoal',
              itemId: 'goalEight',
              link: 'pain-nrs'
            }
          ],
          listeners: {
            show: 'updateSelection'
          }
        }
      ]
    };

    var secondaryGoals = {
      xtype: 'secondarygoals',
      itemId: 'secondaryGoals'
    };

    config = {
      renderTo: config.renderTo,
      hidden: config.hidden,
      cls: 'bsw-body',
      items: [header, filters, infobar, tabs, secondaryGoals]
    };

    this.callParent(arguments);
  },

  listeners: {
    // show: 'updateStores'
  }
});

Ext.define('Boa.view.PrimaryGoal', {
  extend: 'Ext.container.Container',
  xtype: 'primarygoal',
  alias: 'view.primaryGoal',
  viewModel: 'primarygoal',

  constructor: function (config) {
    var origin = {};
    origin.x = 120;
    origin.y = 120;
    var width = 20;
    var goalPercentage = 0;

    var startAngle = Math.PI * 0.5;
    var sprite = Ext.create('Ext.draw.sprite.Line', {
      x1: origin.x + (Math.cos(startAngle + Math.PI * 2 * -goalPercentage) * (94 - width)),
      y1: origin.y - (Math.sin(startAngle + Math.PI * 2 * -goalPercentage) * (94 - width)),
      x2: origin.x + (Math.cos(startAngle + Math.PI * 2 * -goalPercentage) * (94 + width)),
      y2: origin.y - (Math.sin(startAngle + Math.PI * 2 * -goalPercentage) * (94 + width)),

      stroke: '#009666',
      lineDash: [4, 3],
      lineWidth: 2,
      opacity: 1
    });

    this.goalSprite = sprite;

    var goal = {
      xtype: 'draw',
      cls: 'bsw-goal-marker',
      goal: 80,
      sprites: [sprite],
      bodyStyle: 'background:transparent;'
    };

    var title = {
      xtype: 'container',
      items: [
        {
          xtype: 'label',
          bind: {
            html: '{goal.output.indicatorText}'
          },
          cls: 'bsw-goal-title'
        },
        {
          xtype: 'label',
          bind: {
            html: '{goal.output.yearText}'
          },
          cls: 'bsw-goal-title'
        },
        {
          xtype: 'label',
          bind: {
            html: '{goal.output.targetText}'
          },
          cls: 'bsw-goal-subtitle'
        }
      ]
    };

    var percentage = {
      xtype: 'container',
      cls: 'bsw-inner-text',
      items: [{
        xtype: 'label',
        name: 'percentage',
        bind: {
          html: '{percentagetext}'
        },
        cls: 'bsw-goal-percentage'
      },
      {
        xtype: 'label',
        name: 'percentage-text',
        bind: {
          html: '{goal.output.resultDescription}'
        },
        cls: 'bsw-goal-percentage-text'
      }]
    };

    var chart = Ext.create('Ext.chart.PolarChart', {
      width: '240px',
      height: '240px',
      cls: 'bsw-polarchart',
      bind: {
        store: {
          fields: ['g1'],
          data: [
            { g1: '{percentage}' },
            { g1: '{complement}' }
          ]
        }
      },
      series: [
        {
          type: 'pie',
          xField: 'g1',
          donut: 73,
          style: {
            miterLimit: 10,
            lineCap: 'miter',
            lineWidth: 0
          },
          subStyle: {
            strokeStyle: ['white', 'white', 'white', 'white', 'white'],
            lineWidth: [1, 2, 1, 1, 1]
          }
        }
      ],
      colors: ['#dddddd', '#dddddd']
    });

    this.goalChart = chart;

    var year = Ext.create('Boa.view.GoalYear', {
      percentage: 50,
      itemId: 'goalYear'
    });

    var button = {
      xtype: 'button',
      text: 'SE MER',
      cls: 'bsw-button',
      scale: 'large',
      handler: function () {
        this.ownerCt.ownerCt.ownerCt.ownerCt.ownerCt.getController().details(config.link);
      }
    };

    config = {
      link: config.link,
      itemId: config.itemId,
      cls: 'col-md-3 bsw-chartcontainer',
      items: [{
        items: [title, chart, goal, percentage, year, button]
      }]
    };

    this.callParent(arguments);
  },

  updateGoal: function (target, grade) {
    var origin = {};
    origin.x = 120;
    origin.y = 120;
    var width = 20;
    var goalPercentage = target;
    var startAngle = Math.PI * 0.5;

    if (grade === 'unknown') {
      grade = 'none';
      goalPercentage = 0;
    }

    this.goalSprite.setAttributes({
      x1: origin.x + (Math.cos(startAngle + Math.PI * 2 * -goalPercentage) * (94 - width)),
      y1: origin.y - (Math.sin(startAngle + Math.PI * 2 * -goalPercentage) * (94 - width)),
      x2: origin.x + (Math.cos(startAngle + Math.PI * 2 * -goalPercentage) * (94 + width)),
      y2: origin.y - (Math.sin(startAngle + Math.PI * 2 * -goalPercentage) * (94 + width))
    });

    if (grade === undefined) return;

    var grades = [
      'none',
      'bad',
      'almost',
      'good'
    ];

    var value = grades.indexOf(grade);

    var color = [
      'rgb(221, 221, 221)',
      'rgb(237, 72, 38)',
      'rgb(251, 182, 0)',
      'rgb(0, 150, 102)'
    ][value];

    if (!color) color = 'rgba(255,255,255,0)';

    this.goalChart.setSeries({
      type: 'pie',
      xField: 'g1',
      donut: 73,
      style: {
        miterLimit: 10,
        lineCap: 'miter',
        lineWidth: 0
      },
      subStyle: {
        strokeStyle: ['white', 'white', 'white', 'white', 'white'],
        lineWidth: [1, 2, 1, 1, 1]
      },
      colors: [color, '#dddddd']
    });
    this.goalChart.setCenter([120, 120]);
  },

  bind: {
    goalPercentage: '{goal.output.target}'
  },

  setGoalPercentage: function (newValue) {
    this.goalPercentage = newValue;
  },

  goalChart: null,

  setGoalChart: function (newValue) {
    this.goalChart = newValue;
  }
});

Ext.define('Boa.view.PrimaryGoalModel', {
  extend: 'Ext.app.ViewModel',
  alias: 'viewmodel.primarygoal',
  stores: {
    goal: {
      fields: []
    }
  },

  formulas: {
    percentage: function (get) {
      if (get('goal.output.result') === 'NA') return 100;
      return Math.round(100 * get('goal.output.result'));
    },
    percentagetext: function (get) {
      if (get('goal.output.result') === 'NA') return '?';
      return Math.round(100 * get('goal.output.result')) + '%';
    },
    complement: function (get) {
      return 100 - Math.round(100 * get('goal.output.result'));
    }
  }
});

Ext.define('Boa.view.SecondaryGoals', {
  extend: 'Ext.container.Container',
  xtype: 'secondarygoals',
  alias: 'view.secondarygoals',
  viewModel: 'secondary',
  controller: 'overview',
  cls: 'bsw-separator',
  style: { 'margin-bottom': '150px' },
  items: [
    {
      html: '<div class="bsw-target-header">MÅLUPPFYLLNAD</div><div class="bsw-color-legend"><span>Målet inte uppfyllt</span><span>Målet nästan uppfyllt</span><span>Målet uppfyllt</span></div>',
      cls: 'bsw-secondary-header'
    },
    {
      xtype: 'panel',
      bind: {
        html: '<div class="bsw-secondary bsw-grade-{first.output.grade}"><div>{first.output.result}</div><div><div class="patient-rate">{first.output.indicatorText}</div><div class="goal-level">{first.output.targetText}</div></div></div>'
      },
      cls: ' bsw-secondary-line',
      listeners: {
        click: {
          element: 'el',
          fn: function () {
            this.component.up().up().getController().details('xray');
          }
        }
      }
    },
    {
      bind: {
        html: '<div class="bsw-secondary bsw-grade-{second.output.grade}"><div>{second.output.result}</div><div><div class="patient-rate">{second.output.indicatorText}</div><div class="goal-level">{second.output.targetText}</div></div></div>'
      },
      cls: ' bsw-secondary-line',
      listeners: {
        click: {
          element: 'el',
          fn: function () {
            this.component.up().up().getController().details('age');
          }
        }
      }
    },
    {
      bind: {
        html: '<div class="bsw-secondary bsw-grade-{third.output.grade}"><div>{third.output.result}</div><div><div class="patient-rate">{third.output.indicatorText}</div><div class="goal-level">{third.output.targetText}</div></div></div>'
      },
      cls: ' bsw-secondary-line',
      listeners: {
        click: {
          element: 'el',
          fn: function () {
            this.component.up().up().getController().details('no-prior-medical-joint-help');
          }
        }
      }
    },
    {
      bind: {
        html: '<div class="bsw-secondary bsw-grade-{fourth.output.grade}"><div>{fourth.output.result}</div><div><div class="patient-rate">{fourth.output.indicatorText}</div><div class="goal-level">{fourth.output.targetText}</div></div></div>'
      },
      cls: ' bsw-secondary-line',
      listeners: {
        click: {
          element: 'el',
          fn: function () {
            this.component.up().up().getController().details('stop-medication');
          }
        }
      }
    },
    {
      bind: {
        html: '<div class="bsw-secondary bsw-grade-{fifth.output.grade}"><div>{fifth.output.result}</div><div><div class="patient-rate">{fifth.output.indicatorText}</div><div class="goal-level">{fifth.output.targetText}</div></div></div>'
      },
      cls: ' bsw-secondary-line',
      listeners: {
        click: {
          element: 'el',
          fn: function () {
            this.component.up().up().getController().details('completed-school');
          }
        }
      }
    }
  ]
});

Ext.define('Boa.view.SecondaryGoalsModel', {
  extend: 'Ext.app.ViewModel',
  alias: 'viewmodel.secondary',

  stores: {
    first: {
      fields: [],
      output: {
        grade: 'good',
        result: 0,
        indicatorText: 'Hämtar data',
        targetText: '...'
      }

    },
    second: {
      fields: [],
      output: {
        grade: 'good',
        result: 0,
        indicatorText: 'Hämtar data',
        targetText: '...'
      }

    },
    third: {
      fields: [],
      output: {
        grade: 'good',
        result: 0,
        indicatorText: 'Hämtar data',
        targetText: '...'
      }

    },
    fourth: {
      fields: [],
      output: {
        grade: 'good',
        result: 0,
        indicatorText: 'Hämtar data',
        targetText: '...'
      }

    },
    fifth: {
      fields: [],
      output: {
        grade: 'good',
        result: 0,
        indicatorText: 'Hämtar data',
        targetText: '...'
      }
    }
  },
  formulas: {
    firstresult: function (get) {
      return Math.round(100 * get('first.output.result'));
    },
    secondresult: function (get) {
      return Math.round(100 * get('second.output.result'));
    },
    thirdresult: function (get) {
      return Math.round(100 * get('third.output.result'));
    }
  }
});

Ext.define('Boa.view.Table', {
  extend: 'Ext.container.Container',
  xtype: 'boatable',
  alias: 'view.boatable',
  viewModel: 'details',
  height: 800,
  bind: {
    html: '<table id="table" class="bsw-table table">'
            + '    <thead>                       '
            + '      <tr>'
            + '        <th colspan="2"></th><th colspan="2">{table.years.0}</th><th colspan="2">{table.years.1}</th><th colspan="2">{table.years.2}</th><th colspan="2">{table.years.3}</th><th colspan="2">{table.years.4}</th>' + '        <th colspan="2">{table.years.5}</th>'
            + '      </tr>'
            + '      <tr>'
            + '        <th colspan="2">Typ av uppföljning</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th><th>{table.headers.0}</th><th>{table.headers.1}</th>'
            + '      </tr>'
            + '    </thead>'
            + '    <tbody>'
            + '      <tr>'
            + '         <td colspan="2">ALLA PATIENTER</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
            + '      </tr>'
            + '      <tr class="{table.firstvisit}">'
            + '         <td colspan="2">Första besök</td><td>{table.allpatients.firstvisit.0}</td><td>{table.allpatients.firstvisit.1}%</td><td>{table.allpatients.firstvisit.2}</td><td>{table.allpatients.firstvisit.3}%</td><td>{table.allpatients.firstvisit.4}</td><td>{table.allpatients.firstvisit.5}%</td><td>{table.allpatients.firstvisit.6}</td><td>{table.allpatients.firstvisit.7}%</td><td>{table.allpatients.firstvisit.8}</td><td>{table.allpatients.firstvisit.9}%</td><td>{table.allpatients.firstvisit.10}</td><td>{table.allpatients.firstvisit.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">3 månader</td><td>{table.allpatients.threemonths.0}</td><td>{table.allpatients.threemonths.1}%</td><td>{table.allpatients.threemonths.2}</td><td>{table.allpatients.threemonths.3}%</td><td>{table.allpatients.threemonths.4}</td><td>{table.allpatients.threemonths.5}%</td><td>{table.allpatients.threemonths.6}</td><td>{table.allpatients.threemonths.7}%</td><td>{table.allpatients.threemonths.8}</td><td>{table.allpatients.threemonths.9}%</td><td>{table.allpatients.threemonths.10}</td><td>{table.allpatients.threemonths.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">1 år</td><td>{table.allpatients.twelvemonths.0}</td><td>{table.allpatients.twelvemonths.1}%</td><td>{table.allpatients.twelvemonths.2}</td><td>{table.allpatients.twelvemonths.3}%</td><td>{table.allpatients.twelvemonths.4}</td><td>{table.allpatients.twelvemonths.5}%</td><td>{table.allpatients.twelvemonths.6}</td><td>{table.allpatients.twelvemonths.7}%</td><td>{table.allpatients.twelvemonths.8}</td><td>{table.allpatients.twelvemonths.9}%</td><td>{table.allpatients.twelvemonths.10}</td><td>{table.allpatients.twelvemonths.11}%</td>'
            + '      </tr>'
            + '     <tr>'
            + '         <td colspan="2">HÖFT</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
            + '      </tr>'
            + '      <tr class="first-visit">'
            + '         <td colspan="2">Första besök</td><td>{table.hip.firstvisit.0}</td><td>{table.hip.firstvisit.1}%</td><td>{table.hip.firstvisit.2}</td><td>{table.hip.firstvisit.3}%</td><td>{table.hip.firstvisit.4}</td><td>{table.hip.firstvisit.5}%</td><td>{table.hip.firstvisit.6}</td><td>{table.hip.firstvisit.7}%</td><td>{table.hip.firstvisit.8}</td><td>{table.hip.firstvisit.9}%</td><td>{table.hip.firstvisit.10}</td><td>{table.hip.firstvisit.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">3 månader</td><td>{table.hip.threemonths.0}</td><td>{table.hip.threemonths.1}%</td><td>{table.hip.threemonths.2}</td><td>{table.hip.threemonths.3}%</td><td>{table.hip.threemonths.4}</td><td>{table.hip.threemonths.5}%</td><td>{table.hip.threemonths.6}</td><td>{table.hip.threemonths.7}%</td><td>{table.hip.threemonths.8}</td><td>{table.hip.threemonths.9}%</td><td>{table.hip.threemonths.10}</td><td>{table.hip.threemonths.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">1 år</td><td>{table.hip.twelvemonths.0}</td><td>{table.hip.twelvemonths.1}%</td><td>{table.hip.twelvemonths.2}</td><td>{table.hip.twelvemonths.3}%</td><td>{table.hip.twelvemonths.4}</td><td>{table.hip.twelvemonths.5}%</td><td>{table.hip.twelvemonths.6}</td><td>{table.hip.twelvemonths.7}%</td><td>{table.hip.twelvemonths.8}</td><td>{table.hip.twelvemonths.9}%</td><td>{table.hip.twelvemonths.10}</td><td>{table.hip.twelvemonths.11}%</td>'
            + '      </tr>'
            + '     <tr>'
            + '         <td colspan="2">KNÄ</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">Första besök</td><td>{table.knee.firstvisit.0}</td><td>{table.knee.firstvisit.1}%</td><td>{table.knee.firstvisit.2}</td><td>{table.knee.firstvisit.3}%</td><td>{table.knee.firstvisit.4}</td><td>{table.knee.firstvisit.5}%</td><td>{table.knee.firstvisit.6}</td><td>{table.knee.firstvisit.7}%</td><td>{table.knee.firstvisit.8}</td><td>{table.knee.firstvisit.9}%</td><td>{table.knee.firstvisit.10}</td><td>{table.knee.firstvisit.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">3 månader</td><td>{table.knee.threemonths.0}</td><td>{table.knee.threemonths.1}%</td><td>{table.knee.threemonths.2}</td><td>{table.knee.threemonths.3}%</td><td>{table.knee.threemonths.4}</td><td>{table.knee.threemonths.5}%</td><td>{table.knee.threemonths.6}</td><td>{table.knee.threemonths.7}%</td><td>{table.knee.threemonths.8}</td><td>{table.knee.threemonths.9}%</td><td>{table.knee.threemonths.10}</td><td>{table.knee.threemonths.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">1 år</td><td>{table.knee.twelvemonths.0}</td><td>{table.knee.twelvemonths.1}%</td><td>{table.knee.twelvemonths.2}</td><td>{table.knee.twelvemonths.3}%</td><td>{table.knee.twelvemonths.4}</td><td>{table.knee.twelvemonths.5}%</td><td>{table.knee.twelvemonths.6}</td><td>{table.knee.twelvemonths.7}%</td><td>{table.knee.twelvemonths.8}</td><td>{table.knee.twelvemonths.9}%</td><td>{table.knee.twelvemonths.10}</td><td>{table.knee.twelvemonths.11}%</td>'
            + '      </tr>'
            + '     <tr>'
            + '         <td colspan="2">HAND</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">Första besök</td><td>{table.hand.firstvisit.0}</td><td>{table.hand.firstvisit.1}%</td><td>{table.hand.firstvisit.2}</td><td>{table.hand.firstvisit.3}%</td><td>{table.hand.firstvisit.4}</td><td>{table.hand.firstvisit.5}%</td><td>{table.hand.firstvisit.6}</td><td>{table.hand.firstvisit.7}%</td><td>{table.hand.firstvisit.8}</td><td>{table.hand.firstvisit.9}%</td><td>{table.hand.firstvisit.10}</td><td>{table.hand.firstvisit.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">3 månader</td><td>{table.hand.threemonths.0}</td><td>{table.hand.threemonths.1}%</td><td>{table.hand.threemonths.2}</td><td>{table.hand.threemonths.3}%</td><td>{table.hand.threemonths.4}</td><td>{table.hand.threemonths.5}%</td><td>{table.hand.threemonths.6}</td><td>{table.hand.threemonths.7}%</td><td>{table.hand.threemonths.8}</td><td>{table.hand.threemonths.9}%</td><td>{table.hand.threemonths.10}</td><td>{table.hand.threemonths.11}%</td>'
            + '      </tr>'
            + '      <tr>'
            + '         <td colspan="2">1 år</td><td>{table.hand.twelvemonths.0}</td><td>{table.hand.twelvemonths.1}%</td><td>{table.hand.twelvemonths.2}</td><td>{table.hand.twelvemonths.3}%</td><td>{table.hand.twelvemonths.4}</td><td>{table.hand.twelvemonths.5}%</td><td>{table.hand.twelvemonths.6}</td><td>{table.hand.twelvemonths.7}%</td><td>{table.hand.twelvemonths.8}</td><td>{table.hand.twelvemonths.9}%</td><td>{table.hand.twelvemonths.10}</td><td>{table.hand.twelvemonths.11}%</td>'
            + '      </tr>'
            + '    </tbody>'
            + '  </table>'
            + '<div class="spinner">'
            + '<div class="rect1"></div>'
            + '<div class="rect2"></div>'
            + '<div class="rect3"></div>'
            + '<div class="rect4"></div>'
            + '<div class="rect5"></div>'
            + '</div>'
  },

  createExcelLink: function (data) {
    var tag = document.getElementById('exportComparison');
    if (!tag) return;

    var content = 'ENHET; MEDELVÄRDE;\n';
    for (var i = data.length - 1; i > 0; i--) {
      content += data[i].name + ';';
      content += Math.round(data[i].value) + ';\n';
    }
    content = '\ufeff' + content;
    var blob = new Blob([content], {
      type: 'text/csv;chartset=utf-8'
    });
    var url = URL.createObjectURL(blob);

    var callback = function () {
      window.event.preventDefault();
      window.navigator.msSaveBlob(blob, 'boa-statistik.csv');
    };

    if (window.navigator.msSaveBlob) {
      tag.addEventListener('click', callback);
    } else {
      tag.setAttribute('href', url);
    }

    document.getElementById('exportTableBar').setAttribute('class', 'bsw-visible');
  }
});

Ext.define('Boa.view.Trend', {
  extend: 'Ext.chart.CartesianChart',
  xtype: 'trend',
  alias: 'view.trend',
  controller: 'details',
  viewModel: 'details',
  cls: 'bsw-yearchart',
  height: 232,

  config: {
    indicator: ''
  },

  axes: [
    {
      type: 'numeric',
      position: 'left',
      grid: true,
      dashSize: 2,
      titleMargin: 0,
      minimum: 0,
      maximum: 100,
      increment: 20,
      renderer: function (v) { return v.toFixed(0) + '%  '; },
      style: {
        strokeStyle: '#979797',
        majorTickSize: 0
      },
      label: {
        rotate: {
          degrees: 0
        }
      },
      limits: [{
        value: 80,
        line: {
          strokeStyle: '#009666',
          lineDash: [2, 2],
          lineWidth: 1
        }
      }]
    },
    {
      type: 'category',
      position: 'bottom',
      style: { opacity: 0.2, majorTickSize: 0 },
      title: {
        text: '',
        fontFamily: 'Times New Roman',
        fontSize: 15
      },
      label: {
        color: '#183136',
        fontFamily: 'open_sans',
        fontSize: 12,
        textAlign: 'center'
      },
      cls: 'foo',
      fields: 'name'
    }
  ],

  series: {
    stacked: false,
    type: 'bar',
    subStyle: {
      stroke: '#fff'
    },
    style: {
      minGapWidth: 24
    },

    xField: 'name',
    yField: ['value1', 'value2'],

    label: {
      field: 'value1',
      display: 'insideStart',
      fill: '#183136',
      fontSize: 10,
      textBaseline: 'bottom',
      translateX: 8,
      translateY: 10,
      height: 100,
      width: 300,
      calloutColor: 'none',

      renderer: function (value) {
        var text = ' ';
        if (isNaN(value)) {
          text = 'INGEN DATA';
        }

        return text;
      }
    },
    renderer: function (sprite, config, attr, index) {
      var width;
      var color;
      var offsetX = 0;
      if (index === 4) {
        color = (sprite.getField() === 'value1' ? 'rgba(127, 193, 213, 0.5)' : 'rgba(36, 93, 113, 0.5)');
      } else {
        color = (sprite.getField() === 'value1' ? 'rgba(127, 193, 213, 1.0)' : 'rgba(36, 93, 113, 1.0)');
      }

      if (!this.getParent().up('#detailsView').down('#showStateComparison').getValue()) {
        width = (sprite.getField() === 'value1' ? config.width * 2 : 0);
        if (config.width === 13) {
          offsetX = (sprite.getField() === 'value1' ? 3 : 0);
        } else {
          offsetX = (sprite.getField() === 'value1' ? 5 : 0);
        }
      } else {
        width = config.width;
        offsetX = (sprite.getField() === 'value1' ? 2 : 2);
      }

      return Ext.apply(attr, {
        fill: color,
        x: config.x + offsetX,
        width: width
      });
    },
    animation: {
      duration: 500
    },
    tooltip: {
      trackMouse: false,
      height: 28,
      defaultAlign: 'tl-tl',
      boaStyle: true,
      boaWidth: 45,
      anchor: 'bottom',

      renderer: function (record, ctx) {
        var indicator = record.store.data.items[0].data.indicator;
        if (indicator === 'age') {
          this.setHtml(Math.round(record.get(ctx.field)) + ' år');
        } else {
          this.setHtml(Math.round(record.get(ctx.field)) + '%');
        }
      }
    }
  },

  store: {
    fields: ['name', 'value1', 'value2'],
    data: [
      {
        name: '????',
        value1: 0,
        value2: 0
      },
      {
        name: '????     ',
        value1: 0,
        value2: 0
      },
      {
        name: '????   ',
        value1: 0,
        value2: 0
      },
      {
        name: '????  ',
        value1: 0,
        value2: 0
      },
      {
        name: '???? ',
        value1: 0,
        value2: 0
      }
    ]
  },

  sprites: [
    {
      itemId: 'smallsprite',
      type: 'rect',
      x: 55,
      y: 10,
      width: 312,
      height: 30,
      fillStyle: '#009666',
      opacity: 0.1
    },
    {
      itemId: 'bigsprite',
      type: 'rect',
      x: 54,
      y: 10,
      width: 1080,
      height: 44,
      fillStyle: '#009666',
      opacity: 0.1,
      hidden: true
    }
  ],

  setSpriteSize: function (size) {
    if (size === 'small') {
      this.getItems().items[6].getItems()[1].hide();
      this.getItems().items[6].getItems()[0].show();
    } else {
      this.getItems().items[6].getItems()[0].hide();
      this.getItems().items[6].getItems()[1].show();
    }
  },

  resetChart: function () {
    var data = this.getStore().getData().items;

    var store = {
      fields: ['name', 'value1', 'value2'],
      data: [
        {
          name: data[0].data.name,
          value1: 0,
          value2: 0
        },
        {
          name: data[1].data.name,
          value1: 0,
          value2: 0
        },
        {
          name: data[2].data.name,
          value1: 0,
          value2: 0
        },
        {
          name: data[3].data.name,
          value1: 0,
          value2: 0
        },
        {
          name: data[4].data.name,
          value1: 0,
          value2: 0
        }
      ]
    };
    this.axes[0].setLimits({
      value: 0,
      line: {
        strokeStyle: '#009666',
        lineDash: [2, 2],
        lineWidth: 1
      }
    });

    // var smallScaleFactor = 148;
    // var largeScaleFactor = 218;

    this.getItems().items[6].getItems()[0].setAttributes({ y: 0 });
    this.getItems().items[6].getItems()[1].setAttributes({ height: 0 });
    this.getItems().items[6].getItems()[0].setAttributes({ height: 0 });

    this.setStore(store);
    this.hide();
    this.redraw();
    this.show();
  },

  updateChart: function (response) {
    var unitdata = response.choice.output.result;
    var statedata = response.riket ? response.riket.output.result : [{}, {}, {}, {}, {}];
    var target = response.choice.output.target;
    var indicator = response.choice.output.indicator;

    var multiplier = target < 1 ? 100 : 1;

    if (target < 1) {
      this.axes[0].setRenderer(function (v) { return v.toFixed(0) + '%  '; });
    } else {
      this.axes[0].setRenderer(function (v) {
        if (v > 100) return '';
        return v + ' år';
      });
    }

    var max = target < 1 ? 100.001 : 100.002;
    this.axes[0].setMaximum(max);

    var store = {
      fields: ['name', 'value1', 'value2'],
      data: [
        {
          name: unitdata[0].year + '',
          value1: unitdata[0].value * multiplier,
          value2: statedata[0].value * multiplier,
          indicator: indicator
        },
        {
          name: unitdata[1].year + '',
          value1: unitdata[1].value * multiplier,
          value2: statedata[1].value * multiplier
        },
        {
          name: unitdata[2].year + '',
          value1: unitdata[2].value * multiplier,
          value2: statedata[2].value * multiplier
        },
        {
          name: unitdata[3].year + '',
          value1: unitdata[3].value * multiplier,
          value2: statedata[3].value * multiplier
        },
        {
          name: unitdata[4].year + '',
          value1: unitdata[4].value * multiplier,
          value2: statedata[4].value * multiplier
        }
      ]
    };

    this.axes[0].setLimits({
      value: target * multiplier,
      line: {
        strokeStyle: '#009666',
        lineDash: [2, 2],
        lineWidth: 1
      }
    });

    var smallScaleFactor = 148;
    var largeScaleFactor = 218;


    if (indicator === 'xray') {
      this.getItems().items[6].getItems()[0].setAttributes({ y: 10 + (1 - target / 100 * multiplier) * smallScaleFactor });
      this.getItems().items[6].getItems()[1].setAttributes({ height: (target / 100 * multiplier) * largeScaleFactor });
      this.getItems().items[6].getItems()[0].setAttributes({ height: (target / 100 * multiplier) * smallScaleFactor });
    } else {
      this.getItems().items[6].getItems()[1].setAttributes({ height: (1 - target / 100 * multiplier) * largeScaleFactor });
      this.getItems().items[6].getItems()[0].setAttributes({ height: (1 - target / 100 * multiplier) * smallScaleFactor });
      this.getItems().items[6].getItems()[0].setAttributes({ y: 10 });
    }

    this.setStore(store);
    this.hide();
    this.redraw();
    this.show();
  },

  setShowState: function (show) {
    this.showState = show;
  },

  showState: true
});

Ext.application({
  name: 'Boa',
  units: [],
  viewcontrollers: [
    'OverviewController', 'DetailsController'
  ],
  launch: function () {
    var target = (typeof Stratum !== 'undefined') ? Stratum.containers['BOA/Statistics'] : 'contentPanel';
    var mainView = Ext.create('Boa.view.Main', {
      renderTo: target
    });

    Ext.Ajax.request({
      type: 'ajax',
      method: 'get',
      cors: true,
      url: 'https://boa.registercentrum.se/stratum/api/statistics/BOA/boaw-choices-riket-landsting-enhet?rinvoke=1&apiKey=KbxAwmlwLM4%3D',
      success: function (response) {
        var result = Ext.decode(response.responseText).data;
        var stateUnit = { gruppkod: 'R0', etikett: 'Riket' };
        var defaultUnitCode = 'R0';
        if (typeof Profile !== 'undefined' && Profile.Context !== null) {
          defaultUnitCode = 'E' + Profile.Context.Unit.UnitCode;
        }

        var overviewUnits = mainView.down('#overviewView').down('#unitFilter');
        var overviewStore = overviewUnits.getStore();
        overviewStore.setData(result);
        overviewStore.insert(0, stateUnit);
        if (!overviewUnits.getValue()) {
          overviewUnits.setValue(defaultUnitCode);
        } else overviewUnits.setValue(overviewUnits.getValue());

        var detailsunits = mainView.down('#detailsView').down('#unitFilter');
        var detailsStore = detailsunits.getStore();
        detailsStore.setData(result);
        detailsStore.insert(0, stateUnit);
        if (!detailsunits.getValue()) {
          detailsunits.setValue(defaultUnitCode);
        } else detailsunits.setValue(detailsunits.getValue());
        mainView.down('#detailsView').getController().updateLegend();
      }
    });

    Ext.tip.QuickTipManager.init();
    Ext.apply(Ext.QuickTips.getQuickTip(), {
      dismissDelay: 0
    });
  },
  defaultToken: 'overview',
  listen: {
    controller: {
      '#': {
        unmatchedroute: 'onUnmatchedRoute'
      }
    }
  },

  onUnmatchedRoute: function (hash) {
    this.redirectTo('overview');
  }
});

Ext.override(Ext.chart.series.Series, {
  showTip: function (item, xy) {
    var me = this,
      tooltip = me.getTooltip(),
      sprite, surface, surfaceEl, pos, point, bbox, x, y, config, isRtl;
    if (!tooltip) {
      return;
    }
    clearTimeout(me.tooltipTimeout);
    config = tooltip.config;
    if (tooltip.trackMouse) {
      xy[0] += config.offsetX;
      xy[1] += config.offsetY;
    } else {
      sprite = item.sprite;
      surface = sprite.getSurface();
      surfaceEl = Ext.get(surface.getId());
      if (surfaceEl) {
        bbox = item.series.getBBoxForItem(item);
        if (config.boaStyle) {
          if (config.boaOrientation === 'left') {
            x = bbox.x + bbox.width / 2 + tooltip.height / 2;
            y = bbox.y + bbox.height + 5;
          } else {
            x = bbox.x + bbox.width / 2 - tooltip.boaWidth / 2;
            y = bbox.y + bbox.height + tooltip.height + 5;
          }
        } else {
          x = bbox.x + bbox.width / 2;
          y = bbox.y + bbox.height / 2;
        }
        point = surface.matrix.transformPoint([
          x,
          y
        ]);
        pos = surfaceEl.getXY();
        isRtl = surface.getInherited().rtl;
        x = isRtl ? pos[0] + surfaceEl.getWidth() - point[0] : pos[0] + point[0];
        y = pos[1] + point[1];
        xy = [
          x,
          y
        ];
      }
    }
    tooltip.config.renderer.call(tooltip, item.record, item);
    tooltip.show(xy);
  }
});

Ext.override(Ext.scroll.Scroller, {
  privates: {
    restoreState: function () {
      var me = this,
        el = me.getScrollElement(),
        dom;
      if (el) {
        dom = el.dom;

        if (me.trackingScrollTop !== undefined) {
          me.restoring = true;
          Ext.defer(function () {
            me.restoring = false;
          }, 50);
        }
      }
    }
  }
});
